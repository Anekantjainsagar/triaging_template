This is a comprehensive and complex project that involves multiple technologies and a multi-agent system. Here is a high-level plan, including the folder structure and a breakdown of the agent roles and responsibilities.

### Project Plan and Folder Structure

The project will be structured to keep the code organized and the data separate.

```
/project_root
├── app.py                     # Main Streamlit application
├── requirements.txt           # Python dependencies
├── .env                       # Environment variables (API keys)
├── /data        # Contains all the .xlsx and .csv tracker files
│   │── tracker_sheet_1.xlsx
│   │── tracker_sheet_2.csv
│   │── ...
│   ├── /triaging_templates      # Contains the triaging template files
│   │   ├── Rule#280.xlsx
│   │   ├── Rule#002.csv
│   │   └── ...
├── /src
│   ├── crew.py                # Defines the CrewAI agents and tasks
│   ├── utils.py               # Helper functions for data processing, file handling, etc.
│   ├── agents.py              # Agent definitions
│   └── tasks.py               # Task definitions
└── README.md
```

---

### Step-by-Step Execution Plan

#### 1\. Frontend Platform (Streamlit)

- **Initial View:** Create a Streamlit app with a single search box.
- **Search Box Logic:** When a user types, the app will use the **Data Analyst Agent** to query the concatenated data from all tracker sheets.
- **Top 5 Suggestions:** The agent will find and display the top 5 most relevant alert titles based on the user's input. This will be a quick, low-latency search to provide a good user experience.

#### 2\. Alert Selection and Data Consolidation

- **User Action:** A user clicks on one of the suggested alerts.
- **Data Processing Task:** The **Data Consolidation Agent** is activated.
  - It will identify the corresponding tracker sheet file.
  - It will read the entire sheet (xlsx/csv).
  - It will **sum up** the relevant numerical columns (if any) and consolidate all rows for that specific alert.
  - The consolidated data will be formatted into a new pandas DataFrame.
- **File Export:** The consolidated DataFrame will be saved as a new Excel file in a designated output folder, with a clear filename like `consolidated_INC208308.xlsx`.

---

#### 3\. Triaging Template Retrieval

- **Template Search Task:** The **Template Search Agent** takes over.
  - It will use the rule number or keywords from the selected alert to search for the relevant triaging template file within the `/data/triaging_templates` folder.
  - It will read the content of the identified template file.

---

#### 4\. The Triaging Engine (CrewAI Agents)

This is the most complex part, involving multiple agents working together to generate the new template and the step-by-step guidance.

- **Knowledge & Synthesis Agent:**

  - **Role:** Synthesizer and information aggregator.
  - **Tools:**
    - **File Reader Tool:** To read the triaging template.
    - **Web Search Tool (Tavily/Serper):** To get the latest information on the rule, a specific vulnerability, or a KQL query syntax.
    - **LLM (Ollama qwen2.5:0.5b):** To process and synthesize all this information.
  - **Task:** This agent will learn from the template, the consolidated tracker data, and its web searches to create a comprehensive understanding of the alert.

- **Content Generation Agent:**

  - **Role:** Template and content creator.
  - **Tools:** The LLM and the knowledge from the **Knowledge & Synthesis Agent**.
  - **Task:**
    - It will take the learned information and generate a new, **empty** triaging template based on the provided format. This will be a structured document with placeholders for details to be filled in.
    - It will generate a detailed, easy-to-understand explanation for each step of the triaging process.

---

#### 5\. Frontend Walkthrough & Analysis

- **Dynamic UI (Streamlit):** The Streamlit app will switch from the search view to a step-by-step execution view.

- **Progress Bar:** A progress bar will show the user's progress through the triaging steps.

- **Step-by-Step Explanation:**

  - For each step, the app will display the easy-to-understand explanation generated by the **Content Generation Agent**.
  - It will also use the **Prediction & Analysis Agent** to provide additional context.

- **Prediction & Analysis Agent:**

  - **Role:** Predictive analytics from historical data.
  - **Tools:**
    - **Data Analyzer Tool:** To read the `consolidated_INC208308.xlsx` file and the original tracker sheets.
    - **LLM (Ollama):** To reason about the data.
  - **Task:**
    - It will analyze the "resolver comments" from past incidents related to the same rule.
    - Based on these comments and the current data, it will predict the likelihood of the final output being a **True Positive** or **False Positive** at each step of the triage process.
    - It will provide a "confidence score" or a brief explanation of how the current step's data (e.g., "IP Reputation - clean") influences the final outcome.

- **User Interaction:**

  - Each step will have an explanation, a progress update, and a "Next" button.
  - If a step requires additional input, an input box will be provided (e.g., for a KQL query result).
  - The generated KQL queries will be provided directly as text in the explanation.

---

#### 6\. Finalization & Export

- **Completion:** After the user completes all the steps, the process is finalized.
- **Template Download:** A button will appear to download the completed triaging template, which is a new file that combines the empty template structure with the user's inputs.
- **Final Summary:** The app will present a final summary of the findings and the predicted outcome (TP/FP).
