Perfect it's working just kql query is giving unrelevent data as well in the block so do some work on it except that everything is good

Step	Name	Explanation	KQL Query	Execute	Output	Remarks/Comments
	Rule#183-Detect passwordless authentication					
1	Provide the username which are involved in the incident	Complete Provide the username which are involved in the incident by reviewing relevant security data, executing necessary queries, and documenting all findings with timestamps and evidence.	"To generate a KQL query for this investigation step, I have outlined the following steps:
1. **Retrieve username information**: Use the `SigninLogs` table to identify usernames involved in the incident.
2. **Filter by specific events or patterns**: Utilize the provided tables (`IdentityInfo`, `DeviceInfo`) and relevant operators to filter for specific events (e.g., 'Add member to role') related to the target users.
3. **Extend results with additional data**: Ensure that only the necessary columns are extended, in this case, extending the usernames found in the first step.
Here is the complete KQL query:
SigninLogs | extend username = tostring(UserPrincipalName) -- Find usernames using SigninLogs table
IdentityInfo | extend ip_address = to_string(TargetResources[0].IPAddress) -- Target IP address from the IdentityInfo table
DeviceInfo | extend device_id = to_string(DeviceID) -- Device ID from the DeviceInfo table
AuditLogs | where TimeGenerated > ago(<TIMESPAN>) & Filter(username in usernames) -- Filter for usernames found in SigninLogs
### Explanation:
- **SigninLogs** table contains usernames and their associated details.
- **IdentityInfo** table has IP addresses, which can be used to filter by IP addresses.
- **DeviceInfo** table stores device IDs, helping to match the usernames with devices.
This query will provide a KQL query that meets the requirements specified. If there are any specific events or patterns in the `SigninLogs` table you need to address further, I'd be happy to assist in refining this query according to those details."			
2	VIPS Users ?	Cross verify if the user is VIP or not - with the list (Shared by Arcutis)	"IdentityInfo
| where AccountUPN == ""<USER_EMAIL>""
| project AccountUPN, AccountDisplayName, JobTitle, Department, Manager, City, Country
| extend IsVIP = iff(Tags contains ""VIP"" or Tags contains ""Executive"", ""Yes"", ""No"")"			
3	Run the KQL query	Verify the logs whether there is any Application without sign in attempts	"SigninLogs | where UserPrincipalName == ""<USER_EMAIL>"" | extend TimeGenerated = datetime(datetime(), ago(<TIMESPAN>))
AuditLogs | extend LogTime = when(datetime(datetime()), datetime(datetime() + <TIMESPAN>), datetime())
IdentityInfo | where emailAddresses[0] in usersInRole(""Application Administrator"")"			
4	Collect the basic info like UserName, App DisplayName, User Agent, Time	If there is any application sign in without password check whether the application is critical or not	"SigninLogs | where `UserPrincipalName` == ""<USER_EMAIL>"" and AppDisplayName == ""<App DisplayName>""
extend UserPrincipalName,
TimeGenerated,
SecurityIncidentID,
DeviceId as IncidentID,
""isCritical"" as IsCritical,
IdentityInfo as UserInfo
### Explanation:
- `SigninLogs | where `UserPrincipalName` == ""<USER_EMAIL>"" and AppDisplayName == ""<App DisplayName>""`: Collect basic info like `UserName`, `App DisplayName`, `User Agent`, `TimeGenerated`, and `SecurityIncidentID`.
- extend UserPrincipalName, TimeGenerated, SecurityIncidentID, DeviceId as IncidentID, IsCritical, UserInfo: Combine collected data into a single KQL query.
This KQL query is designed to detect passwordless authentication activities within Microsoft Sentinel by collecting and extending necessary information."			
5	User Confirmation - If YES	If no critical applications close the incident as false positive				
6	User Confirmation --- NO. (True Positive)	If any critical application found consider as True Positive	"I now understand that I need to generate an accurate Microsoft Sentinel KQL query for the given requirements. The key elements are:
1. Use only the specified table names: SigninLogs, AuditLogs, IdentityInfo.
2. Include placeholders for user email, IP address, device ID, and time span.
3. Ensure proper KQL operators (where, extend, project, summarize, join).
4. Focus on security investigation data.
Since this is a detailed step-by-step process, I will create a KQL query that meets these criteria and return it as the final answer:
SigninLogs | where UserPrincipalName == ""<USER_EMAIL>"" |
extend LoginTimestamp = if(ActiveTrustedLoginProvider == ""WindowsIdentity"") '2018-09-15 06:47:41.357385' else '2018-09-15 06:47:41.357385'
| extend DeviceID = if(ActiveTrustedDeviceID == ""WindowsIdentity"") '12345678-1234-1234-1234-12345678901' else '12345678-1234-1234-1234-12345678901'
| extend DeviceType = if(ActiveTrustedDeviceID == ""WindowsIdentity"") ""Desktop"" else ""Other""
|
AuditLogs | where OperationName == ""UserLogin"" | join IdentityInfo, [device_id] on (SigninLogs.UserPrincipalName) and (AuditLogs.DeviceID)
This KQL query:
- `SignInLogs` table includes user login information.
- `IdentityInfo` contains the device ID of the user who logged in.
- The `join` operator is used to combine data from both tables based on common attributes (`UserPrincipalName`, `DeviceID`, etc.).
- `AuditLogs` table includes security incident logs, and it's joined with `IdentityInfo` based on the `device_id`.
This query ensures that all necessary information is collected for a thorough Microsoft Sentinel investigation."			
7	Run The KQL to check - AD logs (Sign in logs)	Ensure that the passwordless authentication method used is legitimate (e.g., biometrics, hardware tokens).If there is critical applications without password then reach out IT team to set password by enabling MFA	"SigninLogs
| where UserPrincipalName == ""<USER_EMAIL>""
| where TimeGenerated > ago(<TIMESPAN>)
| extend Location = strcat(LocationDetails.city, "", "", LocationDetails.countryOrRegion)
| extend DeviceName = tostring(DeviceDetail.displayName)
| extend DeviceCompliant = tostring(DeviceDetail.isCompliant)
| extend MFAResult = tostring(AuthenticationDetails[0].succeeded)
| summarize
SignInCount = count(),
UniqueIPs = dcount(IPAddress),
UniqueLocations = dcount(Location),
FailedSignIns = countif(ResultType != ""0""),
Locations = make_set(Location),
IPs = make_set(IPAddress)
by UserPrincipalName
| extend RiskScore = (UniqueIPs * 2) + (UniqueLocations * 3) + (FailedSignIns * 5)"			
8	User Account Details	If the authentication is Legitimate then consider it as False Positive and close the incident	"SigninLogs
| where UserPrincipalName == ""<USER_EMAIL>""
| where TimeGenerated > ago(<TIMESPAN>)
| extend Location = strcat(LocationDetails.city, "", "", LocationDetails.countryOrRegion)
| extend DeviceName = tostring(DeviceDetail.displayName)
| extend DeviceCompliant = tostring(DeviceDetail.isCompliant)
| extend MFAResult = tostring(AuthenticationDetails[0].succeeded)
| summarize
SignInCount = count(),
UniqueIPs = dcount(IPAddress),
UniqueLocations = dcount(Location),
FailedSignIns = countif(ResultType != ""0""),
Locations = make_set(Location),
IPs = make_set(IPAddress)
by UserPrincipalName
| extend RiskScore = (UniqueIPs * 2) + (UniqueLocations * 3) + (FailedSignIns * 5)"			
9	Inform to IT Team	If unauthorized, take appropriate action such as locking accounts, resetting passwords, or investigating further.	"SigninLogs | where TimeGenerated > ago(30)
| extend UserPrincipalName = SigninLogs[UserPrincipalName]
| where UserPrincipalName == ""<USER_EMAIL>""
| project (UserPrincipalName, DeviceId)
| AuditLogs | join(AuditLogs, DeviceId, on: DeviceId)
| where TimeGenerated > ago(15)"			
10	Track for the closer/closer confirmation	Enhance monitoring to detect similar events in the future	"SigninLogs
| where UserPrincipalName == ""<USER_EMAIL>""
| project DeviceId, Timestamp
AuditLogs
| where OperationName == ""Add member to role""
| extend RoleName = tostring(TargetResources[0].modifiedProperties)
This KQL query filters events from `SigninLogs` based on the user's email address and projects them into a device ID. Similarly, it extends the role name from `AuditLogs` when an action called ""Add member to role"" is performed.
You can adjust these queries to match specific conditions or incorporate additional criteria as needed for your investigation."			


