1. Fix this groq issue - DONE  
2. Timeline in the kql query - DONE
3. ip vpn check working or not - DONE
4. ip reputation markdown issue
5. predictions fixed
6. Technical Overview Check
7. Full Workflow to Run via Outside













üîÆ True/False Positive Analyzer with MITRE ATT&CK
‚úÖ Template already uploaded to predictions API

‚úÖ Data verified: 7 investigation steps loaded

üë§ Analyzing 1 Account(s)

üë§ mailto:himanshu.s@yashtechnologies841.onmicrosoft.com - üö® TRUE POSITIVE

üîç Investigation Assessment for: mailto:himanshu.s@yashtechnologies841.onmicrosoft.com
üö® Classification: TRUE POSITIVE

Risk Level

‚ö™ High
Confidence Score

90%
üîé Key Findings by Investigation Step
üü° Finding #1: Geographic Anomaly (MEDIUM)

üîç Step Reference: Verify User Account Status and Check if Account is VIP or High-Priority

üìù Details: Unusual geographic access patterns detected

üî¨ Evidence: ip reputation analysis report
ip address: 14.143.131.254 overall risk: clean (score: 0/100) timestamp: 2025-11-14 08:19:52

==============

‚ö†Ô∏è Impact: Potential account compromise or unauthorized access





now for the user I want the very proper specific investigation
this is a excel that is getting it as an input but sometimes giving very generic points or less points sometimes mitre map not visible handle this properly also if you can change the ui little bit showing in a proper structured way also the accordian should be closed at default
In the predictions tab you have to make this change of this issue






Step Name Explanation KQL Query KQL Explanation Execute Output Remarks/Comments
Manual Analysis: üö® [HIGH RISK] Critical Authentication Failures & Suspicious Rapid Activity - Himanshu S (2 failures/6 events)
1 Scope Verification - All Sign-in Attempts for Himanshu S "Examine all sign-in attempts (both successful and failed) for Himanshu S within a broader timeframe (e.g., 24-48 hours) surrounding the alert time. This helps to understand the full context of activity, identify if the 6 events are isolated or part of a larger pattern, and determine if the user has been experiencing other authentication issues or unusual activity not captured by the initial alert.

WHY THIS MATTERS: This step provides a comprehensive view of Himanshu S's recent authentication activity, allowing the investigator to verify the scope of the alert and identify any related or preceding suspicious events." "SigninLogs
| where TimeGenerated > datetime(2025-11-08 17:48:08Z) and TimeGenerated <= datetime(2025-11-15 17:48:08Z)
| where UserPrincipalName in (""mailto:himanshu.s@yashtechnologies841.onmicrosoft.com"")
| extend Hour = toint(datetime_part(""Hour"", TimeGenerated)), DayOfWeek = toint(dayofweek(TimeGenerated))
| extend DayName = case(
DayOfWeek == 0, ""Sunday"",
DayOfWeek == 1, ""Monday"",
DayOfWeek == 2, ""Tuesday"",
DayOfWeek == 3, ""Wednesday"",
DayOfWeek == 4, ""Thursday"",
DayOfWeek == 5, ""Friday"",
DayOfWeek == 6, ""Saturday"",
""Unknown""
),
IsBusinessHours = iff(Hour >= 8 and Hour <= 18 and DayOfWeek >= 1 and DayOfWeek <= 5, ""Yes"", ""No""),
TimeWindow = case(
Hour >= 0 and Hour < 6, ""Late Night (12AM-6AM)"",
Hour >= 6 and Hour < 9, ""Early Morning (6AM-9AM)"",
Hour >= 9 and Hour < 12, ""Morning (9AM-12PM)"",
Hour >= 12 and Hour < 14, ""Lunch (12PM-2PM)"",
Hour >= 14 and Hour < 18, ""Afternoon (2PM-6PM)"",
Hour >= 18 and Hour < 22, ""Evening (6PM-10PM)"",
""Night (10PM-12AM)""
)
| summarize
SignInCount = count(),
UniqueIPAddresses = dcount(IPAddress),
UniqueApplications = dcount(AppDisplayName),
UniqueDevices = dcount(tostring(DeviceDetail.deviceId)),
SuccessfulSignIns = countif(ResultType == 0),
FailedSignIns = countif(ResultType != 0),
RiskySignIns = countif(IsRisky == true),
IPsList = make_set(IPAddress, 5),
ApplicationsList = make_set(AppDisplayName, 5)
by UserPrincipalName, DayName, TimeWindow, IsBusinessHours, Hour
| extend BehaviorFlag = case(
RiskySignIns > 0, ""üü• RISKY - Suspicious activity detected"",
FailedSignIns > 5, ""üü® WARNING - High failure rate"",
UniqueIPAddresses > 3, ""üü° UNUSUAL - Multiple IP addresses"",
SignInCount > 20, ""üîµ HIGH_VOLUME - Unusual sign-in frequency"",
""üü¢ NORMAL - Typical behavior""
), AnomalyScore = case(
RiskySignIns > 0, 100,
FailedSignIns > 5, 80,
UniqueIPAddresses > 3, 60,
SignInCount > 20, 40,
10
)
| project-reorder UserPrincipalName, BehaviorFlag, AnomalyScore, DayName, TimeWindow, IsBusinessHours, SignInCount
| order by AnomalyScore desc, SignInCount desc" This query aggregates data, enriches fields, formats output, ranks results from SigninLogs to analyze scope verification - all sign-in attempts for himanshu s. "Results: 1 row(s) returned

================================================================================
UserPrincipalName | UserDisplayName | IsVIP | AccountClassification | VIPRiskScore | TotalSignIns | UniqueIPAddresses | UniqueCountries | HighRiskSignIns | MediumRiskSignIns | FailedAttempts | SuccessfulSignIns
mailto:himanshu.s@yashtechnologies841.onmicrosoft.com | Himanshu S | Regular User | üü¢ Low - Normal Activity | 5 | 86 | 8 | 1 | 0 | 0 | 1 | 85
Total Records: 1" [MANUAL] CRITICAL | Tool: KQL
2 Verify User Account Status and Check if Account is VIP or High-Priority "This step analyzes the affected user account to determine their role, privileges, and organizational importance. You will be prompted to provide a list of known VIP users (executives, admins, high-value accounts). The KQL query will then check if the affected users are in the VIP list and assess their risk level based on sign-in patterns, geographic locations, and risk indicators.

WHY THIS MATTERS: VIP/privileged accounts have access to sensitive data and systems. Compromise of such accounts represents a critical security incident requiring immediate escalation and response." "// VIP User Verification Query - PLACEHOLDER
// This query will be dynamically generated during triaging with:
// - VIP user list (provided by analyst)
// - Affected users (from alert entities)
// - Alert timestamp (for accurate time range)

let VIPUsers = datatable(UserPrincipalName:string)
[
    ""<VIP_USER_LIST_PLACEHOLDER>""
];
SigninLogs
| where TimeGenerated > datetime(2025-11-08 17:48:08Z) and TimeGenerated <= datetime(2025-11-15 17:48:08Z)
| where UserPrincipalName in (""himanshu.s@yashtechnologies841.onmicrosoft.com"")
| extend IsVIP = iff(UserPrincipalName in (VIPUsers), ""‚≠ê VIP ACCOUNT"", ""Regular User"")
| summarize
    TotalSignIns = count(),
    UniqueIPAddresses = dcount(IPAddress),
    UniqueCountries = dcount(tostring(LocationDetails.countryOrRegion)),
    HighRiskSignIns = countif(RiskLevelAggregated == ""high""),
    MediumRiskSignIns = countif(RiskLevelAggregated == ""medium""),
    FailedAttempts = countif(ResultType != ""0""),
    SuccessfulSignIns = countif(ResultType == ""0"")
    by UserPrincipalName, UserDisplayName, IsVIP
| extend
    VIPRiskScore = (HighRiskSignIns * 10) + (MediumRiskSignIns * 5) + (FailedAttempts * 2) + (UniqueCountries * 3)
| extend
    AccountClassification = case(
        VIPRiskScore > 30, ""üî¥ Critical - Executive at High Risk"",
        VIPRiskScore > 15, ""üü† High - VIP Requires Attention"",
        VIPRiskScore > 5, ""üü° Medium - Monitor Closely"", 
        ""üü¢ Low - Normal Activity""
    )
| project-reorder UserPrincipalName, UserDisplayName, IsVIP, AccountClassification, VIPRiskScore
| order by VIPRiskScore desc"	Queries SigninLogs to check if affected users are VIP accounts and analyzes their activity patterns, risk levels, and geographic locations. The VIP user list and exact time ranges will be dynamically injected during triaging.		"IP Reputation Analysis Report

============================================================

IP Address: 14.143.131.254
Overall Risk: CLEAN (Score: 0/100)
Timestamp: 2025-11-14 08:19:52

============================================================
VIRUSTOTAL RESULTS
Malicious Detections: 0/95
Suspicious Detections: 0/95
Clean Detections: 60/95
Country: IN
ASN: 4755
Owner: TATA Communications formerly VSNL is Leading ISP

============================================================
ABUSEIPDB RESULTS
Abuse Confidence Score: 0%
Total Reports: 0
Distinct Reporters: 0
Last Reported: None
Country Code: IN
ISP: Internet Service Provider
Usage Type: Fixed Line ISP
Whitelisted: No
Public IP: Yes

============================================================
VPN/PROXY DETECTION
Connection Type: Direct Connection (Low Risk)

VPN Detected: No
Proxy Detected: No
Tor Exit Node: No
Country: Unknown
City: Unknown
ISP: Unknown
Connection Type: Unknown

============================================================
RECOMMENDATION
[NO ACTION] IP appears clean. Continue standard procedures.

VERIFICATION LINKS:
‚Ä¢ VirusTotal: https://www.virustotal.com/gui/ip-address/14.143.131.254
‚Ä¢ AbuseIPDB: https://www.abuseipdb.com/check/14.143.131.254

============================================================

IP Reputation Analysis Report
IP Address: 49.249.104.218
Overall Risk: CLEAN (Score: 0/100)
Timestamp: 2025-11-14 08:19:55

============================================================
VIRUSTOTAL RESULTS
Malicious Detections: 0/95
Suspicious Detections: 0/95
Clean Detections: 61/95
Country: IN
ASN: 45820
Owner: Tata Teleservices ISP AS

============================================================
ABUSEIPDB RESULTS
Abuse Confidence Score: 0%
Total Reports: 0
Distinct Reporters: 0
Last Reported: None
Country Code: IN
ISP: Tata Teleservices Limited -GSM Division
Usage Type: Fixed Line ISP
Whitelisted: No
Public IP: Yes

============================================================
VPN/PROXY DETECTION
Connection Type: Direct Connection (Low Risk)

VPN Detected: No
Proxy Detected: No
Tor Exit Node: No
Country: Unknown
City: Unknown
ISP: Unknown
Connection Type: Unknown

============================================================
RECOMMENDATION
[NO ACTION] IP appears clean. Continue standard procedures.

VERIFICATION LINKS:
‚Ä¢ VirusTotal: https://www.virustotal.com/gui/ip-address/49.249.104.218
‚Ä¢ AbuseIPDB: https://www.abuseipdb.com/check/49.249.104.218

============================================================" [MANUAL] HIGH | Tool: KQL
3 Check Source IP Reputation & VPN/Proxy Detection Using VirusTotal, AbuseIPDB and Abstract API "This step validates the reputation of source IP addresses using external threat intelligence platforms (VirusTotal, AbuseIPDB and Abstract API) and detects VPN/proxy/Tor usage to identify if the IPs are associated with known malicious activity or anonymization services. IPs are automatically extracted from alert entities. Look for high detection ratios (5+ vendors), recent abuse reports, VPN/proxy flags, Tor exit nodes, or associations with known threat actors.

WHY THIS MATTERS: IP reputation and VPN detection provide immediate validation of the threat level. A malicious source IP or VPN/Tor usage strongly indicates suspicious activity that requires further investigation." "Results: 5 row(s) returned

================================================================================
UserPrincipalName | TravelRisk | Country | City | LocationRiskScore | SignInCount | State | UniqueIPsInLocation | SuccessfulSignIns | FailedSignIns | RiskySignIns | FirstSeenInLocation | LastSeenInLocation | IPAddressesList | MinTimeBetweenLocations
mailto:himanshu.s@yashtechnologies841.onmicrosoft.com | üè† Domestic - India | IN | Navi Mumbai | 20 | 21 | Maharashtra | 1 | 20 | 1 | 0 | 2025-11-10T05:34:55.0795352Z | 2025-11-13T12:28:10.9548768Z | [""14.143.131.254""] | 0
mailto:himanshu.s@yashtechnologies841.onmicrosoft.com | üè† Domestic - India | IN | Ahmedabad | 20 | 20 | Gujarat | 1 | 19 | 1 | 0 | 2025-11-11T06:24:40.6026946Z | 2025-11-13T12:16:54.5697813Z | [""49.249.104.218""] | 0
mailto:himanshu.s@yashtechnologies841.onmicrosoft.com | üè† Domestic - India | IN | Chhindwara | 20 | 2 | Madhya Pradesh | 2 | 2 | 0 | 0 | 2025-11-10T08:09:55.6071157Z | 2025-11-11T07:23:39.9050307Z | [""2409:40c4:2004:3555:42e:3186:27bb:ca68"",""2409:40 | 59
mailto:himanshu.s@yashtechnologies841.onmicrosoft.com | üè† Domestic - India | IN | Lamta | 20 | 1 | Madhya Pradesh | 1 | 1 | 0 | 0 | 2025-11-10T06:01:39.7432658Z | 2025-11-10T06:01:39.7432658Z | [""152.56.251.220""] | 25
mailto:himanshu.s@yashtechnologies841.onmicrosoft.com | üè† Domestic - India | IN | Padaliya Bajrang | 0 | 2 | Madhya Pradesh | 1 | 2 | 0 | 0 | 2025-11-09T11:40:49.9622505Z | 2025-11-10T16:42:20.4867663Z | [""49.43.0.128""] | 486
Total Records: 5" [MANUAL] CRITICAL | Tool: virustotal
4 Geographic Analysis - Impossible Travel & Anomalous Locations "Compare the IPAddress and LocationDetails (city, state, country/region) of all sign-in attempts for Himanshu S during the alert timeframe. Identify any instances of ""impossible travel"" where logins occur from geographically distant locations within an impossibly short period. Also, check if any of the locations are unusual or outside Himanshu S's typical access patterns or known corporate VPN egress points.

WHY THIS MATTERS: This step directly investigates the ""Suspicious Rapid Activity"" by identifying potential account compromise through geographic anomalies, a strong indicator of an attacker." "SigninLogs
| where TimeGenerated > datetime(2025-11-08 17:48:08Z) and TimeGenerated <= datetime(2025-11-15 17:48:08Z)
| where UserPrincipalName in (""mailto:himanshu.s@yashtechnologies841.onmicrosoft.com"")
| extend
Country = tostring(LocationDetails.countryOrRegion),
City = tostring(LocationDetails.city),
State = tostring(LocationDetails.state),
Latitude = toreal(LocationDetails.geoCoordinates.latitude),
Longitude = toreal(LocationDetails.geoCoordinates.longitude)
| order by TimeGenerated asc
| extend
PreviousCountry = prev(Country, 1),
PreviousCity = prev(City, 1),
PreviousTime = prev(TimeGenerated, 1),
PreviousLatitude = prev(Latitude, 1),
PreviousLongitude = prev(Longitude, 1)
| extend
TimeDiffMinutes = datetime_diff('minute', TimeGenerated, PreviousTime),
LocationChanged = iff(Country != PreviousCountry or City != PreviousCity, ""Yes"", ""No"")
| where LocationChanged == ""Yes""
| summarize
SignInCount = count(),
UniqueIPsInLocation = dcount(IPAddress),
SuccessfulSignIns = countif(ResultType == ""0""),
FailedSignIns = countif(ResultType != ""0""),
RiskySignIns = countif(IsRisky == true),
FirstSeenInLocation = min(TimeGenerated),
LastSeenInLocation = max(TimeGenerated),
IPAddressesList = make_set(IPAddress, 5),
MinTimeBetweenLocations = min(TimeDiffMinutes)
by UserPrincipalName, Country, City, State
| extend
TravelRisk = case(
MinTimeBetweenLocations < 60 and Country != ""IN"", ""üö® IMPOSSIBLE TRAVEL - <1 Hour"",
MinTimeBetweenLocations < 180 and Country != ""IN"", ""‚ö†Ô∏è Suspicious Travel - <3 Hours"",
MinTimeBetweenLocations < 360 and Country != ""IN"", ""‚ö° Fast Travel - <6 Hours"",
Country != ""IN"", ""‚úàÔ∏è International Access"",
""üè† Domestic - India""
),
LocationRiskScore = case(
MinTimeBetweenLocations < 60, 20,
MinTimeBetweenLocations < 180, 15,
MinTimeBetweenLocations < 360, 10,
Country != ""IN"", 5,
0
)
| project-reorder UserPrincipalName, TravelRisk, Country, City, LocationRiskScore, SignInCount
| order by LocationRiskScore desc, SignInCount desc" This query aggregates data, enriches fields, formats output, ranks results from SigninLogs to analyze geographic analysis - impossible travel & anomalous locations. "Results: 1 row(s) returned

================================================================================
UserPrincipalName | DeviceRiskLevel | DeviceRiskScore | ComplianceStatus | ManagementStatus | OperatingSystem | Browser | TotalSignIns | DeviceId | IsCompliant | IsManaged | TrustType | UniqueIPAddresses | UniqueLocations | UniqueApplications | SuccessfulSignIns | FailedSignIns | RiskySignIns | InteractiveSignIns | FirstUsed | LastUsed | LocationsList | ApplicationsList | IPsList | DaysUsed
mailto:himanshu.s@yashtechnologies841.onmicrosoft.com | ‚ö†Ô∏è Low Risk - Monitor | 8 | ‚ö†Ô∏è Unknown | ‚ö†Ô∏è Unknown | Windows10 | Chrome 142.0.0 | 87 | | | | | 6 | 1 | 9 | 84 | 3 | 0 | 87 | 2025-11-09T11:40:49.9622505Z | 2025-11-13T12:28:10.9548768Z | [""IN""] | [""Office365 Shell WCSS-Client"",""Microsoft Account | [""14.143.131.254"",""152.56.251.220"",""2409:40c4:2004 | 5
Total Records: 1" [MANUAL] CRITICAL | Tool: KQL
5 Device/Endpoint Analysis - Device Health & Compliance "For any successful sign-ins associated with the suspicious activity, identify the DeviceId from the SigninLogs. Cross-reference this DeviceId with DeviceInfo to ascertain the device's health, compliance status, operating system, and if it's a known or managed device belonging to Himanshu S. An unknown, non-compliant, or unhealthy device could indicate a compromised endpoint or an attacker using an unmanaged device.

WHY THIS MATTERS: Helps determine if the access originated from a legitimate, secure device or an unmanaged/compromised endpoint, which is vital for assessing the risk of account compromise." "SigninLogs
| where TimeGenerated > datetime(2025-11-08 17:48:08Z) and TimeGenerated <= datetime(2025-11-15 17:48:08Z)
| where UserPrincipalName in (""mailto:himanshu.s@yashtechnologies841.onmicrosoft.com"")
| extend
DeviceId = tostring(DeviceDetail.deviceId),
OperatingSystem = tostring(DeviceDetail.operatingSystem),
Browser = tostring(DeviceDetail.browser),
IsCompliant = tostring(DeviceDetail.isCompliant),
IsManaged = tostring(DeviceDetail.isManaged),
TrustType = tostring(DeviceDetail.trustType)
| summarize
TotalSignIns = count(),
UniqueIPAddresses = dcount(IPAddress),
UniqueLocations = dcount(tostring(LocationDetails.countryOrRegion)),
UniqueApplications = dcount(AppDisplayName),
SuccessfulSignIns = countif(ResultType == ""0""),
FailedSignIns = countif(ResultType != ""0""),
RiskySignIns = countif(IsRisky == true),
InteractiveSignIns = countif(IsInteractive == true),
FirstUsed = min(TimeGenerated),
LastUsed = max(TimeGenerated),
LocationsList = make_set(tostring(LocationDetails.countryOrRegion), 5),
ApplicationsList = make_set(AppDisplayName, 10),
IPsList = make_set(IPAddress, 5)
by UserPrincipalName, DeviceId, OperatingSystem, Browser, IsCompliant, IsManaged, TrustType
| extend
DaysUsed = datetime_diff('day', LastUsed, FirstUsed) + 1,
ComplianceStatus = case(
IsCompliant == ""true"", ""‚úÖ Compliant"",
IsCompliant == ""false"", ""‚ùå Non-Compliant"",
""‚ö†Ô∏è Unknown""
),
ManagementStatus = case(
IsManaged == ""true"", ""‚úÖ Managed"",
IsManaged == ""false"", ""‚ùå Unmanaged"",
""‚ö†Ô∏è Unknown""
),
DeviceRiskScore = case(
IsCompliant == ""false"" and IsManaged == ""false"", 20,
IsCompliant == ""false"" or IsManaged == ""false"", 15,
RiskySignIns > 5, 12,
FailedSignIns > 10, 10,
IsCompliant == """" or IsManaged == """", 8,
0
)
| extend
DeviceRiskLevel = case(
DeviceRiskScore >= 20, ""üî¥ Critical Risk - Non-Compliant & Unmanaged"",
DeviceRiskScore >= 15, ""üü† High Risk - Partial Compliance"",
DeviceRiskScore >= 10, ""üü° Medium Risk - Security Issues"",
DeviceRiskScore > 0, ""‚ö†Ô∏è Low Risk - Monitor"",
""üü¢ Secure Device""
)
| project-reorder UserPrincipalName, DeviceRiskLevel, DeviceRiskScore, ComplianceStatus, ManagementStatus, OperatingSystem, Browser, TotalSignIns
| order by DeviceRiskScore desc, TotalSignIns desc" This query aggregates data, enriches fields, formats output, ranks results from SigninLogs to analyze device/endpoint analysis - device health & compliance. [MANUAL] HIGH | Tool: KQL