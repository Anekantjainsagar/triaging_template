1	How many users are impacted ?	Gather details of all users - (By adding sheet to this excel)	SigninLogs | where TimeGenerated >= ago(7d) | summarize Count = count() by UserPrincipalName | project UserPrincipalName, Count	Aggregates and counts from sign-in logs.			[ORIGINAL_TEMPLATE] MEDIUM
2	Run the KQL query then, Check for IP Address, UserName, Location & Time and User agent	Review login event details (user account, IP address, time,  Geo location & User agent) Analyze audit and signin logs to identify successful and failed attempts for last 7 days & device history.	"let startTime = ago(7d); let endTime = now(); let signinLogs = SigninLogs     | where TimeGenerated between (startTime .. endTime)     | summarize SuccessfulAttempts = countif(ResultType == ""Success""), FailedAttempts = countif(ResultType == ""Failure"") by UserPrincipalName, IPAddress, Location, UserAgent, bin(TimeGenerated, 1h); let auditLogs = AuditLogs     | where TimeGenerated between (startTime .. endTime)     | summarize by UserPrincipalName, ActivityDisplayName, bin(TimeGenerated, 1h); signinLogs | join kind=inner (auditLogs) on UserPrincipalName | project UserPrincipalName, IPAddress, Location, UserAgent, TimeGenerated, SuccessfulAttempts, FailedAttempts | order by TimeGenerated desc | take 100"	Aggregates and counts from sign-in logs.			[ORIGINAL_TEMPLATE] MEDIUM
3	IP Validation - if Malicious	Check IP reputation using VirusTotal If bad score, take a screenshot for documentation					[ORIGINAL_TEMPLATE] MEDIUM
4	Identify All Affected Endpoints and User Accounts Involved	Determine the full scope of the incident by counting all unique endpoints and user accounts associated with the suspicious PowerShell activity. This helps understand the potential breadth of compromise and resource allocation for the investigation.	SigninLogs | where TimeGenerated > ago(7d) | summarize UserCount = dcount(UserPrincipalName), TotalSignIns = count()	Aggregates data and counts unique values from sign-in logs.			[AI_GENERATED] CRITICAL
5	Analyze Recent Sign-in Activity for Involved User Accounts	Review the sign-in times, frequencies, and source IP addresses for the affected user accounts around the time of the alert. Look for any deviations from normal behavior or unusual login patterns.	SigninLogs | where TimeGenerated >= ago(7d) | summarize SignInCount = count(), UniqueIPs = dcount(IPAddress) by UserPrincipalName, bin(TimeGenerated, 1h) | project UserPrincipalName, SignInCount, UniqueIPs, TimeGenerated | order by TimeGenerated desc	Aggregates data and counts unique values from sign-in logs.			[AI_GENERATED] HIGH
6	VIP Users	Cross-check usernames with VIP list from Arcutis	SigninLogs | where TimeGenerated >= ago(7d) | where UserPrincipalName in ('vipuser1@arcutis.com', 'vipuser2@arcutis.com', 'vipuser3@arcutis.com') // Replace with actual VIP usernames | summarize Count = count() by UserPrincipalName | order by Count desc	Aggregates and counts from sign-in logs.			[ORIGINAL_TEMPLATE] MEDIUM
7	Check External IP and Domain Reputation for Connections	Investigate any external IP addresses or domains contacted by the suspicious PowerShell process using threat intelligence sources. This helps identify known malicious infrastructure or command and control servers.					[AI_GENERATED] HIGH
8	Examine Network Connections Initiated by PowerShell Process	Identify any outbound or inbound network connections made by the suspicious PowerShell process. This can reveal C2 communication, data exfiltration, or lateral movement attempts.					[AI_GENERATED] HIGH
9	Assess Device Compliance and Trust Status of Endpoints	Review the compliance status, health, and trust level of the endpoints where the suspicious PowerShell executed. Non-compliant or untrusted devices may indicate a pre-existing compromise.					[AI_GENERATED] HIGH
10	Compare Current PowerShell Activity with Historical Baselines	Analyze the detected PowerShell commands and scripts against historical execution patterns for the user or endpoint. Identify deviations from normal administrative or user behavior.					[AI_GENERATED] MEDIUM
11	Review File System Modifications Associated with PowerShell Activity	Investigate any file creations, modifications, or deletions on the affected endpoint around the time of the PowerShell execution. Look for dropped malware, persistence mechanisms, or data exfiltration staging.	DeviceInfo | summarize DeviceSignIns = count(), UniqueUsers = dcount(UserPrincipalName) by DeviceId, IsCompliant = tostring(DeviceDetail.isCompliant)	Aggregates data and counts unique values from device information.			[AI_GENERATED] HIGH
13	Investigate Resource Access and Privilege Escalation Attempts	Examine what resources (files, shares, cloud resources) the user or process accessed after the PowerShell execution. Look for attempts to elevate privileges or access sensitive data.	"AuditLogs | where TimeGenerated >= ago(7d) | where OperationName in (""Add member to role"", ""Update role"", ""Add owner"", ""Add group member"") | project TimeGenerated, UserPrincipalName, OperationName, TargetResources, ResultStatus"	Extracts specific fields from audit logs.			[AI_GENERATED] HIGH
14	Analyze Full PowerShell Command Line Arguments and Script Blocks	Extract and decode the complete PowerShell command-line arguments, script blocks (Event ID 4104), and module logging (Event ID 4103) for detailed analysis. Look for obfuscation, unusual parameters, or known malicious patterns.	"AuditLogs | where TimeGenerated >= ago(7d) | where OperationName == ""PowerShell"" | project TimeGenerated, Caller, ResourceId, ResultDescription, AdditionalDetails"	Extracts specific fields from audit logs.			[AI_GENERATED] CRITICAL
15	Trace Parent-Child Process Relationships for PowerShell Execution	Identify the parent process that launched the suspicious PowerShell command and any child processes it subsequently spawned. This helps understand the initial execution vector and subsequent actions.					[AI_GENERATED] CRITICAL








DEBUG: rule_number = 297
DEBUG: original_steps count = 8
DEBUG: First original step: {'step_name': 'How many users are impacted ?', 'explanation': 'Gather details of all users - (By adding sheet to this excel)', 'input_required': '', 'kql_query': ''}
📊 PHASE 1: Building investigation profile...
✅ Investigation Profile Builder initialized

🔍 Building Investigation Profile for 297
   📡 Fetching AI analysis for: 297
   ✅ Parsed AI analysis successfully
   ✅ Profile: 0 MITRE, 0 actors, 4 focus areas
   ✅ Profile complete:
      - MITRE Techniques: 0
      - Threat Actors: 0
      - Investigation Focus: ['suspicious_process_execution', 'network_analysis', 'powershell_script_analysis', 'command_line_analysis'] 

🤖 PHASE 2: Generating investigation steps...
✅ Using Gemini for step generation
✅ Web search enabled for step generation
✅ Dynamic Investigation Step Library initialized

Generating investigation steps for 297
DEBUG: Profile keys: dict_keys(['rule_number', 'alert_name', 'alert_type', 'technical_overview', 'mitre_techniques', 'mitre_details', 'threat_actors', 'threat_actor_ttps', 'data_sources', 'investigation_focus', 'required_checks', 'business_impact', 'detection_mechanism'])  
DEBUG: MITRE techniques: []
DEBUG: Threat actors: []

🔬 Generating investigation steps for 297
   🌐 Researching investigation practices...
Maximum iterations reached. Requesting final answer.
   ✅ Found guidance: how to investigate 297 SOC playbook incident response...
   ❌ Filtered duplicate type: Evaluate User Account Context and Associated Privileges
   ❌ Filtered duplicate type: Examine Geographic Locations of User Sign-ins for Anomalies
   ❌ Filtered duplicate type: Verify Multi-Factor Authentication Status and Recent Changes
   ❌ Filtered duplicate type: Identify Concurrent User Sessions and Related Activities
   ✅ Generated 11 investigation steps
   ✅ Generated 11 investigation steps

🔄 PHASE 3: Merging with original template...
✅ Investigation Step Merger initialized
   ✅ Original steps (investigative): 4
✅ Investigation Step Merger initialized

Merging investigation steps...
DEBUG: Original steps received: 4
DEBUG: Generated steps received: 11
   Investigative (original): 4 steps
   Duplicates found: 0
   Unique new steps: 11
   ✅ Final merged steps: 15

================================================================================
📊 TEMPLATE MERGE REPORT
================================================================================

📋 ORIGINAL TEMPLATE:
   Total steps: 4
   Investigative steps: 4
   Filtered out: 0 (remediation/closure steps)

🤖 AI GENERATED:
   Total generated: 11
   Duplicates: 0
   Unique new steps: 11

✅ FINAL MERGED TEMPLATE:
   Total investigation steps: 15
   From original: 4
   Newly added: 11

🆕 NEWLY ADDED STEPS:
   1. Identify All Affected Endpoints and User Accounts Involved
      Priority: CRITICAL | Reason: Enhanced coverage
   2. Analyze Recent Sign-in Activity for Involved User Accounts
      Priority: HIGH | Reason: Enhanced coverage
   3. Check External IP and Domain Reputation for Connections
      Priority: HIGH | Reason: Enhanced coverage
   4. Examine Network Connections Initiated by PowerShell Process
      Priority: HIGH | Reason: Enhanced coverage
   5. Assess Device Compliance and Trust Status of Endpoints
      Priority: HIGH | Reason: Enhanced coverage
   6. Compare Current PowerShell Activity with Historical Baselines
      Priority: MEDIUM | Reason: Enhanced coverage
   7. Review File System Modifications Associated with PowerShell Activity
      Priority: HIGH | Reason: Enhanced coverage
   8. Investigate New Scheduled Tasks or Service Creations for Persistence
      Priority: HIGH | Reason: Enhanced coverage
   9. Investigate Resource Access and Privilege Escalation Attempts
      Priority: HIGH | Reason: Identity/Access analysis
   10. Analyze Full PowerShell Command Line Arguments and Script Blocks
      Priority: CRITICAL | Reason: Enhanced coverage
   11. Trace Parent-Child Process Relationships for PowerShell Execution
      Priority: CRITICAL | Reason: Enhanced coverage

================================================================================


⚙️  PHASE 4: Generating KQL queries and finalizing...

   Step 1: How many users are impacted ?
      Source: original_template | Priority: MEDIUM | Confidence: HIGH
      🔍 Generating KQL...

🔍 Generating KQL for Step 1: How many users are impacted ?
   📊 Context: count_impact
   🌐 Calling kqlsearch.com API...
   ✅ KQL received from API (127 chars)
   ⚠️ Explanation generation failed: litellm.NotFoundError: VertexAIException - {
  "error": {
    "code": 404,
    "message": "models/ge
   ✅ Generated from kqlsearch.com API
      ✅ KQL generated (127 chars)

   Step 2: Run the KQL query then, Check for IP Address, UserName, Location & Time and User agent
      Source: original_template | Priority: MEDIUM | Confidence: HIGH
      🔍 Generating KQL...

🔍 Generating KQL for Step 2: Run the KQL query then, Check for IP Address, UserName, Location & Time and User agent
   📊 Context: count_impact
   🌐 Calling kqlsearch.com API...
   ✅ KQL received from API (709 chars)
   ⚠️ Explanation generation failed: litellm.NotFoundError: VertexAIException - {
  "error": {
    "code": 404,
    "message": "models/ge
   ✅ Generated from kqlsearch.com API
      ✅ KQL generated (709 chars)

   Step 3: IP Validation - if Malicious
      Source: original_template | Priority: MEDIUM | Confidence: HIGH
      ℹ️  Step doesn't require KQL

   Step 4: Identify All Affected Endpoints and User Accounts Involved
      Source: ai_generated | Priority: CRITICAL | Confidence: CRITICAL
      🔍 Generating KQL...

🔍 Generating KQL for Step 4: Identify All Affected Endpoints and User Accounts Involved
   📊 Context: count_impact
   🌐 Calling kqlsearch.com API...
   ✅ KQL received from API (174 chars)
   🔄 Trying dynamic query builder...
   ⚠️ Explanation generation failed: litellm.NotFoundError: VertexAIException - {
  "error": {
    "code": 404,
    "message": "models/ge
   ✅ Generated from dynamic builder
      ✅ KQL generated (116 chars)

   Step 5: Analyze Recent Sign-in Activity for Involved User Accounts
      Source: ai_generated | Priority: HIGH | Confidence: HIGH
      🔍 Generating KQL...

🔍 Generating KQL for Step 5: Analyze Recent Sign-in Activity for Involved User Accounts
   📊 Context: count_impact
   🌐 Calling kqlsearch.com API...
   ✅ KQL received from API (250 chars)
   ⚠️ Explanation generation failed: litellm.NotFoundError: VertexAIException - {
  "error": {
    "code": 404,
    "message": "models/ge
   ✅ Generated from kqlsearch.com API
      ✅ KQL generated (250 chars)

   Step 6: VIP Users
      Source: original_template | Priority: MEDIUM | Confidence: HIGH
      🔍 Generating KQL...

🔍 Generating KQL for Step 6: VIP Users
   📊 Context: verify_vip_user
   🌐 Calling kqlsearch.com API...
   ✅ KQL received from API (253 chars)
   ⚠️ Explanation generation failed: litellm.NotFoundError: VertexAIException - {
  "error": {
    "code": 404,
    "message": "models/ge
   ✅ Generated from kqlsearch.com API
      ✅ KQL generated (253 chars)

   Step 7: Check External IP and Domain Reputation for Connections
      Source: ai_generated | Priority: HIGH | Confidence: HIGH
      ℹ️  Step doesn't require KQL

   Step 8: Examine Network Connections Initiated by PowerShell Process
      Source: ai_generated | Priority: HIGH | Confidence: HIGH
      ℹ️  Step doesn't require KQL

   Step 9: Assess Device Compliance and Trust Status of Endpoints
      Source: ai_generated | Priority: HIGH | Confidence: HIGH
      ℹ️  Step doesn't require KQL

   Step 10: Compare Current PowerShell Activity with Historical Baselines
      Source: ai_generated | Priority: MEDIUM | Confidence: MEDIUM
      ℹ️  Step doesn't require KQL

   Step 11: Review File System Modifications Associated with PowerShell Activity
      Source: ai_generated | Priority: HIGH | Confidence: HIGH
      🔍 Generating KQL...

🔍 Generating KQL for Step 11: Review File System Modifications Associated with PowerShell Activity
   📊 Context: verify_device
   🌐 Calling kqlsearch.com API...
   ✅ KQL received from API (225 chars)
   🔄 Trying dynamic query builder...
   ⚠️ Explanation generation failed: litellm.NotFoundError: VertexAIException - {
  "error": {
    "code": 404,
    "message": "models/ge
   ✅ Generated from dynamic builder
      ✅ KQL generated (149 chars)

   Step 12: Investigate New Scheduled Tasks or Service Creations for Persistence
      Source: ai_generated | Priority: HIGH | Confidence: HIGH
      🔍 Generating KQL...

🔍 Generating KQL for Step 12: Investigate New Scheduled Tasks or Service Creations for Persistence
   📊 Context: verify_device
   🌐 Calling kqlsearch.com API...
   ✅ KQL received from API (213 chars)
   🔄 Trying dynamic query builder...
   ⚠️ Explanation generation failed: litellm.NotFoundError: VertexAIException - {
  "error": {
    "code": 404,
    "message": "models/ge
   ✅ Generated from dynamic builder
      ✅ KQL generated (149 chars)

   Step 13: Investigate Resource Access and Privilege Escalation Attempts
      Source: ai_generated | Priority: HIGH | Confidence: HIGH
      🔍 Generating KQL...

🔍 Generating KQL for Step 13: Investigate Resource Access and Privilege Escalation Attempts
   📊 Context:
   🌐 Calling kqlsearch.com API...
   ✅ KQL received from API (227 chars)
   ⚠️ Explanation generation failed: litellm.NotFoundError: VertexAIException - {
  "error": {
    "code": 404,
    "message": "models/ge
   ✅ Generated from kqlsearch.com API
      ✅ KQL generated (227 chars)

   Step 14: Analyze Full PowerShell Command Line Arguments and Script Blocks
      Source: ai_generated | Priority: CRITICAL | Confidence: CRITICAL
      🔍 Generating KQL...

🔍 Generating KQL for Step 14: Analyze Full PowerShell Command Line Arguments and Script Blocks
   📊 Context:
   🌐 Calling kqlsearch.com API...
   ✅ KQL received from API (162 chars)
   ⚠️ Explanation generation failed: litellm.NotFoundError: VertexAIException - {
  "error": {
    "code": 404,
    "message": "models/ge
   ✅ Generated from kqlsearch.com API
      ✅ KQL generated (162 chars)

   Step 15: Trace Parent-Child Process Relationships for PowerShell Execution
      Source: ai_generated | Priority: CRITICAL | Confidence: CRITICAL
      ℹ️  Step doesn't require KQL
   🗑️ Removed duplicate KQL step: Investigate New Scheduled Tasks or Service Creations for Persiste nce

================================================================================
✅ COMPLETED in 277.1s: 14 investigation steps
================================================================================


The problem is it's giving steps without kql query so don't include those steps in the final triaging template or generate kql query for the same also if you can improve the kql explaination and the normal explaination that will be more good give me the updated functions/sections for teh same