# (venv) D:\Agentic AI\Projects\soc\triaging_template>python test.py

# KQL CLEANING TEST

# 📝 ORIGINAL (MESSY) KQL:

To generate a KQL query for this investigation step, I have outlined the following steps:

1. **Retrieve username information**: Use the `SigninLogs` table to identify usernames involved in the incident.
2. **Filter by specific events or patterns**: Utilize the provided tables (`IdentityInfo`, `DeviceInfo`) and relevant operators to filter for specific events (e.g., 'Add member to role') related to the target users.
3. **Extend results with additional data**: Ensure that only the necessary columns are extended, in this case, extending the usernames found in the first step.
   Here is the complete KQL query:
   SigninLogs | extend username = tostring(UserPrincipalName) -- Find usernames using SigninLogs table
   IdentityInfo | extend ip_address = to_string(TargetResources[0].IPAddress) -- Target IP address from the IdentityInfo table
   DeviceInfo | extend device_id = to_string(DeviceID) -- Device ID from the DeviceInfo table
   AuditLogs | where TimeGenerated > ago(<TIMESPAN>) & Filter(username in usernames) -- Filter for usernames found in SigninLogs

### Explanation:

- **SigninLogs** table contains usernames and their associated details.
- **IdentityInfo** table has IP addresses, which can be used to filter by IP addresses.
- **DeviceInfo** table stores device IDs, helping to match the usernames with devices.
  This query will provide a KQL query that meets the requirements specified. If there are any specific events or patterns in the `SigninLogs` table you need to address further, I'd be happy to assist in refining this query according to those details.

Length: 1564 characters

ðŸ§¹ Cleaning KQL (original: 1564 chars)...
âœ… Cleaned to 661 chars

# ✨ CLEANED KQL:

SigninLogs table to identify usernames involved in the incident. 3. Extend results with additional data: Ensure that only the necessary columns are extended, in this case, extending the usernames found in the first step.
SigninLogs | extend username = tostring(UserPrincipalName) -- Find usernames using SigninLogs table
IdentityInfo | extend ip_address = to_string(TargetResources[0].IPAddress) -- Target IP address from the IdentityInfo table
DeviceInfo | extend device_id = to_string(DeviceID) -- Device ID from the DeviceInfo table
AuditLogs | where TimeGenerated > ago(<TIMESPAN>) & Filter(username in usernames) -- Filter for usernames found in SigninLogs

Length: 661 characters

# 📊 RESULT:

✅ Removed 903 characters of junk
✅ Reduced by 57.7%

================================================================================
TEST 2: Another messy KQL
================================================================================
Original length: 1606 characters

ðŸ§¹ Cleaning KQL (original: 1606 chars)...
âœ… Cleaned to 110 chars

# ✨ CLEANED:

SigninLogs, AuditLogs, IdentityInfo. 3. Ensure proper KQL operators (where, extend, project, summarize, join).

Length: 110 characters
✅ Reduced by 93.2%
