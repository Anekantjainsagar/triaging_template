
âœ… Using Gemini for template generation
âœ… Primary LLM: Gemini 1.5 Flash
âœ… Web search enabled (Serper)

================================================================================
Ã°Å¸Â§  INTELLIGENT TEMPLATE GENERATION FOR MANUAL_GEN
================================================================================

DEBUG: rule_number = MANUAL_GEN
DEBUG: original_steps count = 0
DEBUG: First original step: NONE
ğŸ“Š PHASE 1: Building investigation profile...
âœ… Investigation Profile Builder initialized

 Building Investigation Profile for MANUAL_GEN
   Fetching AI analysis for: MANUAL_GEN       
   Ã¢Å“â€¦ Parsed AI analysis successfully
   Ã¢Å“â€¦ Profile: 0 MITRE, 0 actors, 5 focus areas
   âœ… Profile complete:
      - MITRE Techniques: 0
      - Threat Actors: 0
      - Investigation Focus: ['user_activity', 'authentication_analysis', 'ip_reputation', 'device_compliance', 'behavioral_patterns']  

ğŸ¤– PHASE 2: Generating investigation steps...
âœ… Using Gemini for step generation
âœ… Web search enabled for step generation
âœ… Dynamic Investigation Step Library initialized

Generating investigation steps for MANUAL_GEN
DEBUG: Profile keys: dict_keys(['rule_number', 'alert_name', 'alert_type', 'technical_overview', 'mitre_techniques', 'mitre_details', 'threat_actors', 'threat_actor_ttps', 'data_sources', 'investigation_focus', 'required_checks', 'business_impact', 'detection_mechanism', 
'existing_step_names'])
DEBUG: MITRE techniques: []
DEBUG: Threat actors: []

ğŸ”¬ Generating investigation steps for MANUAL_GEN
   ğŸŒ Researching investigation practices...
   âœ… Found guidance: how to investigate MANUAL_GEN SOC playbook incident response...
   âœ… Generated 4 investigation steps
   âœ… Generated 4 investigation steps

ğŸ”„ PHASE 3: Merging with original template...
âœ… Investigation Step Merger initialized
   âœ… Original steps (investigative): 0
âœ… Investigation Step Merger initialized

Merging investigation steps...
DEBUG: Original steps received: 0
DEBUG: Generated steps received: 4
   Investigative (original): 0 steps
   Duplicates found: 0
   Unique new steps: 4
   âœ… Final merged steps: 4

================================================================================
ğŸ“Š TEMPLATE MERGE REPORT
================================================================================

ğŸ“‹ ORIGINAL TEMPLATE:
   Total steps: 0
   Investigative steps: 0
   Filtered out: 0 (remediation/closure steps)

ğŸ¤– AI GENERATED:
   Total generated: 4
   Duplicates: 0
   Unique new steps: 4

âœ… FINAL MERGED TEMPLATE:
   Total investigation steps: 4
   From original: 0
   Newly added: 4

ğŸ†• NEWLY ADDED STEPS:
   1. Validate Source IP Reputation using External Threat Intelligence
      Priority: CRITICAL | Reason: Threat actor TTP coverage
   2. Investigate User's Email for Related Phishing Attempts or Malware Delivery
      Priority: CRITICAL | Reason: Enhanced coverage
   3. Analyze User Sign-in Behavior for Impossible Travel or Unusual Access Patterns
      Priority: HIGH | Reason: Credential security
   4. Review Credential Usage for Password Spraying or Brute Force Attempts
      Priority: HIGH | Reason: Identity/Access analysis

================================================================================


âš™ï¸  PHASE 4: Generating KQL queries and finalizing...
   ğŸ“Š Original steps: 0
   ğŸ¤– AI-generated steps: 4

   âœ… Processing ORIGINAL steps (keeping all)...

   âœ… Kept all 0 ORIGINAL steps

   âœ… Processing AI-GENERATED steps (filtering if no KQL)...
      âœ… Keeping AI step (External Tool): Validate Source IP Reputation using External Threat Intelligence

      Step 2: Investigate User's Email for Related Phishing Attempts or Malware Delivery
         Source: ai_generated | Priority: CRITICAL
         ğŸ” Generating KQL...

ğŸ” Generating KQL for Step 2: Investigate User's Email for Related Phishing Attempts or Malware Delivery
   ğŸ“Š Context:
   ğŸŒ Calling kqlsearch.com API...
   âœ… KQL received from API (217 chars)
   âœ… Generated from kqlsearch.com API
         âœ… KQL generated (217 chars)
         ğŸ“ Explanation: Counts daily successful and failed sign-ins for each user from SigninLogs over t...

      Step 3: Analyze User Sign-in Behavior for Impossible Travel or Unusual Access Patterns
         Source: ai_generated | Priority: HIGH
         ğŸ” Generating KQL...

ğŸ” Generating KQL for Step 3: Analyze User Sign-in Behavior for Impossible Travel or Unusual Access Patterns
   ğŸ“Š Context: count_impact
   ğŸŒ Calling kqlsearch.com API...
         ğŸ” Generating KQL...

ğŸ” Generating KQL for Step 3: Analyze User Sign-in Behavior for Impossible Travel or Unusual Access Patterns
   ğŸ“Š Context: count_impact
   ğŸŒ Calling kqlsearch.com API...
   ğŸ“Š Context: count_impact
   ğŸŒ Calling kqlsearch.com API...
   ğŸŒ Calling kqlsearch.com API...
   âœ… KQL received from API (486 chars)
   âœ… Generated from kqlsearch.com API
         âœ… KQL generated (486 chars)
         ğŸ“ Explanation: Counts SigninLogs events by user, hourly, and location over the last 7 days to e...
