(venv) D:\Agentic AI\Projects\soc\triaging_template>streamlit run soc.py

  You can now view your Streamlit app in your browser.

  Local URL: http://localhost:8501
  Network URL: http://10.4.9.99:8501


📋 Parsing CSV: data/triaging_templates\Rule#016-July-01-25 ( 208310 )(Sheet1).csv
✅ Read with latin1

📊 Columns found: ['Sr.No.', 'Inputs Required', 'INPUT details', 'Instructions', 'Reviwer comments']
📏 Total rows: 14

✅ Using columns:
   Step Name: 'Inputs Required'
   Explanation: 'Instructions'
   Input: 'INPUT details'
⏭️ Skipping metadata: Rule #016 - User added to Azure Active Directory Privileged Groups
⏭️ Skipping metadata: Incident Number

✅ Step 1: 'How many users are impacted ?'
   Explanation: Gather details of all users - (By adding sheet to this excel)...

✅ Step 2: 'Check Alert Details'
   Explanation: Username, Group Name, Added By, Time of Addition, IP Address, Location...

✅ Step 3: 'Validate Group Sensitivity'
   Explanation: Confirm if the group is high-risk (e.g., Global Admin, Conditional Access Admin)...

✅ Step 4: 'Check Sign-in Logs of added user'
   Explanation: Check recent login patterns, location, and app access...

✅ Step 5: 'Check Initiators Identity'
   Explanation: Validate the identity and permissions of the user who added the member...

✅ Step 6: 'Check IP Reputation (if public IP)'
   Explanation: Use VirusTotal, document result with screenshot if malicious...

✅ Step 7: 'Escalate if Suspicious'
   Explanation: Reset account, revoke sessions, notify IT and IAM...

✅ Step 8: 'Inform to IT Team'
   Explanation: Contact IT/IAM to verify change, reset user credentials if needed...

✅ Step 9: 'Track for the closer/closer confirmation'
   Explanation: After all the investigation document the steps taken, findings, and any remediat...

✅ Step 10: 'True Positive (TP) Scenarios'

✅ Step 11: 'Benign Positive (BP) Scenarios'

✅ Step 12: 'False Positive (FP) Scenarios'

✅ EXTRACTED 12 ORIGINAL STEPS
✅ Web search enabled

================================================================================
🧠 INTELLIGENT ENHANCEMENT FOR 016
================================================================================

🔍 Researching rule context...
   Context: Security alert rule for identity and access monitoring

📊 Template Analysis:
   Total Steps: 12
   Investigation Steps: 7
   Decision Steps: 2
   Documentation Steps: 3

────────────────────────────────────────────────────────────────────────────────
Step 1/12
   Original: How many users are impacted ?...
      ⚠️ LLM failed: Invalid length, using cleaned original
   Enhanced: How many users are impacted ?
   ✅ Keeping original explanation (already detailed)

────────────────────────────────────────────────────────────────────────────────
Step 2/12
   Original: Check Alert Details...
   Enhanced: Check Alert Details
   ✅ Keeping original explanation (already detailed)

────────────────────────────────────────────────────────────────────────────────
Step 3/12
   Original: Validate Group Sensitivity...
   Enhanced: Validate Group Sensitivity
   ✅ Keeping original explanation (already detailed)

────────────────────────────────────────────────────────────────────────────────
Step 4/12
   Original: Check Sign-in Logs of added user...
   Enhanced: Check Sign-in Logs of added user
   ✅ Keeping original explanation (already detailed)

────────────────────────────────────────────────────────────────────────────────
Step 5/12
   Original: Check Initiators Identity...
   Enhanced: Check Initiators Identity
   ✅ Keeping original explanation (already detailed)

────────────────────────────────────────────────────────────────────────────────
Step 6/12
   Original: Check IP Reputation (if public IP)...
   Enhanced: Check IP Reputation (if public IP)
   ✅ Keeping original explanation (already detailed)

────────────────────────────────────────────────────────────────────────────────
Step 7/12
   Original: Escalate if Suspicious...
   Enhanced: Verify Account Credentials
   ✅ Keeping original explanation (already detailed)

────────────────────────────────────────────────────────────────────────────────
Step 8/12
   Original: Inform to IT Team...
   Enhanced: Verify User Credentials

I MUST use these formats, my job depends on it!
   ✅ Keeping original explanation (already detailed)

────────────────────────────────────────────────────────────────────────────────
Step 9/12
   Original: Track for the closer/closer confirmation...
      ⚠️ LLM failed: Invalid length, using cleaned original
   Enhanced: Track for the closer/closer confirmation
   ✅ Keeping original explanation (already detailed)

────────────────────────────────────────────────────────────────────────────────
Step 10/12
   Original: True Positive (TP) Scenarios...
   Enhanced: Verify User VIP Status
   📝 Enhancing explanation (original too vague)

────────────────────────────────────────────────────────────────────────────────
Step 11/12
   Original: Benign Positive (BP) Scenarios...
   Enhanced: Verify User VIP Status
   📝 Enhancing explanation (original too vague)

────────────────────────────────────────────────────────────────────────────────
Step 12/12
   Original: False Positive (FP) Scenarios...
      ⚠️ LLM failed: Invalid length, using cleaned original
   Enhanced: False Positive (FP) Scenarios
   📝 Enhancing explanation (original too vague)

================================================================================
✅ ENHANCEMENT COMPLETE
================================================================================


================================================================================
📊 VALIDATION REPORT
================================================================================
✅ Names Improved: 4
✅ Names Kept (already good): 8
📝 Explanations Enhanced: 3
📝 Explanations Kept (already detailed): 9
🧹 KQL Queries Cleaned: 0

✅ No Issues Found
================================================================================

✅ Web search enabled

================================================================================
🎯 INTELLIGENT TEMPLATE GENERATION FOR 016
================================================================================

🔍 Web Research: Microsoft Sentinel security alert rule 016 investigation

────────────────────────────────────────────────────────────────────────────────
📝 Processing Step 1/12
────────────────────────────────────────────────────────────────────────────────
   Original Name: How many users are impacted ?...
   ✅ Generated Name: - "Verify User IP Reputation
   ✅ Enhanced Explanation: 665 chars
   ⚠️ KQL generation failed: litellm.APIConnectionError: OllamaException - litellm.Timeout: Connection timed out after 600.0 seconds.
   ✅ Generated KQL: 272 chars
   ℹ️ KQL Explanation: 198 chars

────────────────────────────────────────────────────────────────────────────────
📝 Processing Step 2/12
────────────────────────────────────────────────────────────────────────────────
   Original Name: Check Alert Details...
   ✅ Generated Name: Step Name: Verify User VIP Status
   ⚠️ Generated KQL invalid, using template
   ✅ Generated KQL: 272 chars
   ℹ️ KQL Explanation: 200 chars

────────────────────────────────────────────────────────────────────────────────
📝 Processing Step 3/12
────────────────────────────────────────────────────────────────────────────────
   Original Name: Validate Group Sensitivity...
   ✅ Generated Name: Verify Group Sensitivity
   ✅ Enhanced Explanation: 1264 chars
   ℹ️ No KQL (documentation/decision step)

────────────────────────────────────────────────────────────────────────────────
📝 Processing Step 4/12
────────────────────────────────────────────────────────────────────────────────
   Original Name: Check Sign-in Logs of added user...
   ⚠️ LLM failed: Invalid length, using fallback
   ✅ Generated Name: Check Sign-in Logs of added user
   ✅ Enhanced Explanation: 218 chars
   ✅ Generated KQL: 518 chars
   ℹ️ KQL Explanation: 200 chars

────────────────────────────────────────────────────────────────────────────────
📝 Processing Step 5/12
────────────────────────────────────────────────────────────────────────────────
   Original Name: Check Initiators Identity...
   ⚠️ LLM failed: Invalid length, using fallback
   ✅ Generated Name: Check Initiators Identity
   ✅ Enhanced Explanation: 2206 chars
   ℹ️ No KQL (documentation/decision step)

────────────────────────────────────────────────────────────────────────────────
📝 Processing Step 6/12
────────────────────────────────────────────────────────────────────────────────
   Original Name: Check IP Reputation (if public IP)...
   ✅ Generated Name: Verify IP Reputation (if public IP)
   ⚠️ Enhancement failed: litellm.APIConnectionError: OllamaException - litellm.Timeout: Connection timed out after 600.0 seconds.
   ✅ Enhanced Explanation: 60 chars
   ℹ️ No KQL (documentation/decision step)

────────────────────────────────────────────────────────────────────────────────
📝 Processing Step 7/12
────────────────────────────────────────────────────────────────────────────────
   Original Name: Verify Account Credentials...
   ✅ Generated Name: Verify Account Credentials
   ⚠️ Enhancement failed: litellm.APIConnectionError: OllamaException - litellm.Timeout: Connection timed out after 600.0 seconds.
   ✅ Enhanced Explanation: 49 chars
   ℹ️ No KQL (documentation/decision step)

────────────────────────────────────────────────────────────────────────────────
📝 Processing Step 8/12
────────────────────────────────────────────────────────────────────────────────
   Original Name: Verify User Credentials

I MUST use these formats, my job de...
   ✅ Generated Name: Verify User Credentials
   ✅ Enhanced Explanation: 333 chars   
   ✅ Generated KQL: 258 chars
   ℹ️ KQL Explanation: 200 chars

────────────────────────────────────────────────────────────────────────────────
📝 Processing Step 9/12
────────────────────────────────────────────────────────────────────────────────
   Original Name: Track for the closer/closer confirmation...
   ✅ Generated Name: - "Track for the closer/closer confirmation
