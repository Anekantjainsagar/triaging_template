
✅ Using Gemini for template generation
✅ Primary LLM: Gemini 1.5 Flash
✅ Web search enabled (Serper)

================================================================================
ðŸ§  INTELLIGENT TEMPLATE GENERATION FOR MANUAL_GEN
================================================================================

DEBUG: rule_number = MANUAL_GEN
DEBUG: original_steps count = 0
DEBUG: First original step: NONE
📊 PHASE 1: Building investigation profile...
✅ Investigation Profile Builder initialized

 Building Investigation Profile for MANUAL_GEN
   Fetching AI analysis for: MANUAL_GEN       
   âœ… Parsed AI analysis successfully
   âœ… Profile: 0 MITRE, 0 actors, 5 focus areas
   ✅ Profile complete:
      - MITRE Techniques: 0
      - Threat Actors: 0
      - Investigation Focus: ['user_activity', 'authentication_analysis', 'ip_reputation', 'device_compliance', 'behavioral_patterns']  

🤖 PHASE 2: Generating investigation steps...
✅ Using Gemini for step generation
✅ Web search enabled for step generation
✅ Dynamic Investigation Step Library initialized

Generating investigation steps for MANUAL_GEN
DEBUG: Profile keys: dict_keys(['rule_number', 'alert_name', 'alert_type', 'technical_overview', 'mitre_techniques', 'mitre_details', 'threat_actors', 'threat_actor_ttps', 'data_sources', 'investigation_focus', 'required_checks', 'business_impact', 'detection_mechanism', 
'existing_step_names'])
DEBUG: MITRE techniques: []
DEBUG: Threat actors: []

🔬 Generating investigation steps for MANUAL_GEN
   🌐 Researching investigation practices...
   ✅ Found guidance: how to investigate MANUAL_GEN SOC playbook incident response...
   ✅ Generated 4 investigation steps
   ✅ Generated 4 investigation steps

🔄 PHASE 3: Merging with original template...
✅ Investigation Step Merger initialized
   ✅ Original steps (investigative): 0
✅ Investigation Step Merger initialized

Merging investigation steps...
DEBUG: Original steps received: 0
DEBUG: Generated steps received: 4
   Investigative (original): 0 steps
   Duplicates found: 0
   Unique new steps: 4
   ✅ Final merged steps: 4

================================================================================
📊 TEMPLATE MERGE REPORT
================================================================================

📋 ORIGINAL TEMPLATE:
   Total steps: 0
   Investigative steps: 0
   Filtered out: 0 (remediation/closure steps)

🤖 AI GENERATED:
   Total generated: 4
   Duplicates: 0
   Unique new steps: 4

✅ FINAL MERGED TEMPLATE:
   Total investigation steps: 4
   From original: 0
   Newly added: 4

🆕 NEWLY ADDED STEPS:
   1. Validate Source IP Reputation using External Threat Intelligence
      Priority: CRITICAL | Reason: Threat actor TTP coverage
   2. Investigate User's Email for Related Phishing Attempts or Malware Delivery
      Priority: CRITICAL | Reason: Enhanced coverage
   3. Analyze User Sign-in Behavior for Impossible Travel or Unusual Access Patterns
      Priority: HIGH | Reason: Credential security
   4. Review Credential Usage for Password Spraying or Brute Force Attempts
      Priority: HIGH | Reason: Identity/Access analysis

================================================================================


⚙️  PHASE 4: Generating KQL queries and finalizing...
   📊 Original steps: 0
   🤖 AI-generated steps: 4

   ✅ Processing ORIGINAL steps (keeping all)...

   ✅ Kept all 0 ORIGINAL steps

   ✅ Processing AI-GENERATED steps (filtering if no KQL)...
      ✅ Keeping AI step (External Tool): Validate Source IP Reputation using External Threat Intelligence

      Step 2: Investigate User's Email for Related Phishing Attempts or Malware Delivery
         Source: ai_generated | Priority: CRITICAL
         🔍 Generating KQL...

🔍 Generating KQL for Step 2: Investigate User's Email for Related Phishing Attempts or Malware Delivery
   📊 Context:
   🌐 Calling kqlsearch.com API...
   ✅ KQL received from API (217 chars)
   ✅ Generated from kqlsearch.com API
         ✅ KQL generated (217 chars)
         📝 Explanation: Counts daily successful and failed sign-ins for each user from SigninLogs over t...

      Step 3: Analyze User Sign-in Behavior for Impossible Travel or Unusual Access Patterns
         Source: ai_generated | Priority: HIGH
         🔍 Generating KQL...

🔍 Generating KQL for Step 3: Analyze User Sign-in Behavior for Impossible Travel or Unusual Access Patterns
   📊 Context: count_impact
   🌐 Calling kqlsearch.com API...
         🔍 Generating KQL...

🔍 Generating KQL for Step 3: Analyze User Sign-in Behavior for Impossible Travel or Unusual Access Patterns
   📊 Context: count_impact
   🌐 Calling kqlsearch.com API...
   📊 Context: count_impact
   🌐 Calling kqlsearch.com API...
   🌐 Calling kqlsearch.com API...
   ✅ KQL received from API (486 chars)
   ✅ Generated from kqlsearch.com API
         ✅ KQL generated (486 chars)
         📝 Explanation: Counts SigninLogs events by user, hourly, and location over the last 7 days to e...
