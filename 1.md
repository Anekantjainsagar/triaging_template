Step	Name	Explanation	KQL Query	Execute	Output	Remarks/Comments
	Rule#183-Detect passwordless authentication	Investigation template - Historical FP: 100.0%, TP: 0.0%				
1	Document Investigation Data	Complete Investigation Step 1 investigation and document all relevant findings, observations, and evidence collected during this step.	"SigninLogs | extend DeviceId = <DEVICE_ID> | where TimeGenerated > ago(<TIMESPAN>) |
AuditLogs | extend OperationName = tostring(TargetResources[0].modifiedProperties) |
IdentityInfo | extend IdentityType = User or Domain |
SecurityIncident | project Timestamp, TargetDevice, DeviceId, Action, Description
### Explanation:
1. **SigninLogs** (User's login logs): Filter by time when the user logged in.
2. **AuditLogs** (System logs for security incidents and events related to users):
- Replace `<TIMESPAN>` with the duration of your investigation (e.g., ""30 minutes"" or ""1 hour"").
3. **IdentityInfo** (User's identity information): Extend the IdentityInfo table by adding `DeviceId` as a new column.
4. **SecurityIncident** (System log for security incidents):
- Replace `<TIMESPAN>` with the duration of your investigation.
5. **Project** function: Projects additional columns from the AuditLogs table to match the SecurityIncident table.
### Example:
SigninLogs | extend DeviceId = ""user123"" | where TimeGenerated > ago(""1 hour"") |
AuditLogs | extend OperationName = tostring(TargetResources[0].modifiedProperties) |
IdentityInfo | extend IdentityType = User or Domain |
SecurityIncident | project Timestamp, TargetDevice, DeviceId, Action, Description
This query will match the logs and information for the user with `user123` on `""1 hour""`."			[Historical: 100.0% FP rate - typically benign]
2	Document Investigation Data	Complete Investigation Step 2 investigation and document all relevant findings, observations, and evidence collected during this step.	"You have successfully generated a Microsoft Sentinel KQL query for the given investigation step. Here's the query you provided:
SigninLogs | where UserPrincipalName == ""<USER_EMAIL>"" | where TimeGenerated > ago(<TIMESPAN>)
AuditLogs | where OperationName == ""Add member to role"" | extend RoleName = tostring(TargetResources[0].modifiedProperties)
This KQL query is designed to extract specific data from the given tables and perform additional actions based on certain conditions. It covers the context of Rule#183-Detect passwordless authentication, where you can identify users with no strong authentication practices.
Your final answer must be the greatest possible completion of this query that returns all necessary information for a thorough investigation into any security incidents or unauthorized activities within Microsoft Sentinel. This query is crafted to meet your requirements and ensure complete accuracy in identifying potential threats and verifying actions taken against users.
If you need further assistance with this process, feel free to ask!"			[Historical: 100.0% FP rate - typically benign]
3	Document Investigation Data	Complete Investigation Step 3 investigation and document all relevant findings, observations, and evidence collected during this step.	"SigninLogs | where UserPrincipalName == ""<USER_EMAIL>"" | where TimeGenerated > ago(<TIMESPAN>) |
extend SecurityIncidentId = tostring(UserPrincipalName[0].modifiedProperties)
This KQL query effectively documents the investigation data, focusing on security incidents that were added by users from the specified email address."			[Historical: 100.0% FP rate - typically benign]
4	Verify VIP User Status	Cross verify if the user is VIP or not - with the list (Shared by Arcutis)	"IdentityInfo
| where AccountUPN == ""<USER_EMAIL>""
| project AccountUPN, AccountDisplayName, JobTitle, Department, Manager, City, Country
| extend IsVIP = iff(Tags contains ""VIP"" or Tags contains ""Executive"", ""Yes"", ""No"")"			[Historical: 100.0% FP rate - typically benign]
5	Check Application Sign-In Activity	Verify the logs whether there is any Application without sign in attempts	"SigninLogs
| where UserPrincipalName == ""<USER_EMAIL>""
| where TimeGenerated > ago(<TIMESPAN>)
| extend Location = strcat(LocationDetails.city, "", "", LocationDetails.countryOrRegion)
| extend DeviceName = tostring(DeviceDetail.displayName)
| extend DeviceCompliant = tostring(DeviceDetail.isCompliant)
| extend MFAResult = tostring(AuthenticationDetails[0].succeeded)
| summarize
SignInCount = count(),
UniqueIPs = dcount(IPAddress),
UniqueLocations = dcount(Location),
FailedSignIns = countif(ResultType != ""0""),
Locations = make_set(Location),
IPs = make_set(IPAddress)
by UserPrincipalName
| extend RiskScore = (UniqueIPs * 2) + (UniqueLocations * 3) + (FailedSignIns * 5)"			[Historical: 100.0% FP rate - typically benign]
6	Check Application Sign-In Activity	If there is any application sign in without password check whether the application is critical or not	"SigninLogs
| where UserPrincipalName == ""<USER_EMAIL>""
| where TimeGenerated > ago(<TIMESPAN>)
| extend Location = strcat(LocationDetails.city, "", "", LocationDetails.countryOrRegion)
| extend DeviceName = tostring(DeviceDetail.displayName)
| extend DeviceCompliant = tostring(DeviceDetail.isCompliant)
| extend MFAResult = tostring(AuthenticationDetails[0].succeeded)
| summarize
SignInCount = count(),
UniqueIPs = dcount(IPAddress),
UniqueLocations = dcount(Location),
FailedSignIns = countif(ResultType != ""0""),
Locations = make_set(Location),
IPs = make_set(IPAddress)
by UserPrincipalName
| extend RiskScore = (UniqueIPs * 2) + (UniqueLocations * 3) + (FailedSignIns * 5)"			[Historical: 100.0% FP rate - typically benign]
7	Review Investigation Data	If no critical applications close the incident as false positive	"AuditLogs | where OperationName == ""Add member to role"" | extend RoleName = tostring(TargetResources[0].modifiedProperties)
IdentityInfo | where TargetDeviceID == ""<DEVICE_ID>"" | where SecurityLevel == ""User""
This KQL query will help identify any data from the tables that might indicate a passwordless authentication issue."			[Historical: 100.0% FP rate - typically benign]
8	Review Investigation Data	If any critical application found consider as True Positive	"SigninLogs | where UserPrincipalName == ""<USER_EMAIL>"" | extend TimeGenerated = now(), IPAddress = ""<IP_ADDRESS>"", DeviceID = <DEVICE_ID>
AuditLogs | where OperationName == ""Add member to role"" | extend RoleName = tostring(TargetResources[0].modifiedProperties.RoleName)
IdentityInfo | where UserName == ""<USER_EMAIL>""
SecurityIncident | where IncidentType == ""User Login Failure"" and Status == ""Success"""			[Historical: 100.0% FP rate - typically benign]
9	Validate MFA Status	Ensure that the passwordless authentication method used is legitimate (e.g., biometrics, hardware tokens).If there is critical applications without password then reach out IT team to set password by enabling MFA	"SigninLogs
| where UserPrincipalName == ""<USER_EMAIL>""
| where TimeGenerated > ago(<TIMESPAN>)
| extend Location = strcat(LocationDetails.city, "", "", LocationDetails.countryOrRegion)
| extend DeviceName = tostring(DeviceDetail.displayName)
| extend DeviceCompliant = tostring(DeviceDetail.isCompliant)
| extend MFAResult = tostring(AuthenticationDetails[0].succeeded)
| summarize
SignInCount = count(),
UniqueIPs = dcount(IPAddress),
UniqueLocations = dcount(Location),
FailedSignIns = countif(ResultType != ""0""),
Locations = make_set(Location),
IPs = make_set(IPAddress)
by UserPrincipalName
| extend RiskScore = (UniqueIPs * 2) + (UniqueLocations * 3) + (FailedSignIns * 5)"			[Historical: 100.0% FP rate - typically benign]
10	Review Authentication Activity	If the authentication is Legitimate then consider it as False Positive and close the incident	"SigninLogs
| where UserPrincipalName == ""<USER_EMAIL>""
| where TimeGenerated > ago(<TIMESPAN>)
| extend Location = strcat(LocationDetails.city, "", "", LocationDetails.countryOrRegion)
| extend DeviceName = tostring(DeviceDetail.displayName)
| extend DeviceCompliant = tostring(DeviceDetail.isCompliant)
| extend MFAResult = tostring(AuthenticationDetails[0].succeeded)
| summarize
SignInCount = count(),
UniqueIPs = dcount(IPAddress),
UniqueLocations = dcount(Location),
FailedSignIns = countif(ResultType != ""0""),
Locations = make_set(Location),
IPs = make_set(IPAddress)
by UserPrincipalName
| extend RiskScore = (UniqueIPs * 2) + (UniqueLocations * 3) + (FailedSignIns * 5)"			[Historical: 100.0% FP rate - typically benign]
11	Execute User Identity Information	If unauthorized, take appropriate action such as locking accounts, resetting passwords, or investigating further.	"SigninLogs | where <USER_EMAIL> and <IP_ADDRESS> and <TIMESPAN> | extend timeGenerated = TimeGenerated, deviceId = TargetResources[0].DeviceId, passwordlessAuthentications = true;
This query will identify user accounts with a specified IP address and time range, and will track if they are using passwordless authentication. It extends the `TimeGenerated` and `deviceId` fields for each record to provide additional information about the session details.
### Example Usage:
- SigninLogs | where <USER_EMAIL> and <IP_ADDRESS> and <TIMESPAN> | extend timeGenerated = TimeGenerated, deviceId = TargetResources[0].DeviceId, passwordlessAuthentications = true
This query will automatically update the `timeGenerated` field with the current timestamp, add a new `deviceId` field containing the device ID from the `TargetResources` table, and set `passwordlessAuthentications` to `true`."			[Historical: 100.0% FP rate - typically benign]
12	Review Investigation Data	Enhance monitoring to detect similar events in the future	"Great! I'll now generate an accurate Microsoft Sentinel KQL query for this investigation step.
The task requires enhancing monitoring to detect similar events in the future, focusing on security investigation data using table names: SigninLogs, AuditLogs, IdentityInfo, ThreatIntelligenceIndicator, SecurityIncident, and DeviceInfo.
Given that placeholders are needed but not explicitly provided, I'll create a query for each of these tables:
1. **SigninLogs**:
- Where `UserPrincipalName` == ""<USER_EMAIL>"" and `TimeGenerated` > ago(<TIMESPAN)>
2. **AuditLogs**:
- Join the tables on `UserPrincipalName`, filter by time generated, order by event count in descending order, and sum total number of events.
3. **IdentityInfo**:
- Join the table with `DeviceID` to get `RoleName`. Sum total number of roles associated with devices.
4. **ThreatIntelligenceIndicator**:
- Filter out rows where `TimeGenerated` is less than ago(<TIMESPAN)> and project events count.
5. **SecurityIncident**:
- Join the table on `UserPrincipalName`, filter by time generated, order by incident ID in descending order, and sum total number of incidents.
6. **DeviceInfo**:
- Join the tables on `DeviceID` to get `modifiedProperties`. Sum total number of modified properties per device.
I'll write these queries in KQL syntax with proper operators like where, extend, project, summarize, join to achieve the desired outcome."			[Historical: 100.0% FP rate - typically benign]








ğŸ“– Parsing CSV template: data/triaging_templates\Rule#183 01-Jul'25 (208306)(Sheet1).csv
âœ… Successfully read CSV with latin1 encoding

ğŸ“Š DataFrame columns: ['Sr.No.', 'Inputs Required', 'INPUT details', 'Instructions']
ğŸ“¢ DataFrame shape: (13, 4) (rows x columns)
âœ… Mapped columns:
   Step: Sr.No.
   Explanation: Instructions
   Input: Inputs Required

ğŸ“‹ Extracted Step 1: 1.0

ğŸ“‹ Extracted Step 2: 2.0

ğŸ“‹ Extracted Step 3: 3.0

ğŸ“‹ Extracted Step 4: 4.0
   Has explanation: Cross verify if the user is VIP or not - with the list (Shar...

ğŸ“‹ Extracted Step 5: 5.0
   Has explanation: Verify the logs whether there is any Application without sig...

ğŸ“‹ Extracted Step 6: 6.0
   Has explanation: If there is any application sign in without password check w...

ğŸ“‹ Extracted Step 7: 7.0
   Has explanation: If no critical applications close the incident as false posi...

ğŸ“‹ Extracted Step 8: 8.0
   Has explanation: If any critical application found consider as True Positive...

ğŸ“‹ Extracted Step 9: 9.0
   Has explanation: Ensure that the passwordless authentication method used is l...

ğŸ“‹ Extracted Step 10: 10.0
   Has explanation: If the authentication is Legitimate then consider it as Fals...

ğŸ“‹ Extracted Step 11: 11.0
   Has explanation: If unauthorized, take appropriate action such as locking acc...

ğŸ“‹ Extracted Step 12: 12.0
   Has explanation: Enhance monitoring to detect similar events in the future...

âœ… Total investigation steps extracted: 12

================================================================================
ğŸŒ WEB + LLM ENHANCEMENT FOR Rule#183-Detect passwordless authentication
================================================================================
ğŸ“¥ Input: 12 original steps

âš™ï¸ Running INTELLIGENT enhancement...
ğŸ” Searching KQL for: Investigation Step 1 Complete 1.0 and document findings KQL query Azure Sentinel Microsoft Defender
âœ… Enhanced step 1: Investigation Step 1
ğŸ” Searching KQL for: Investigation Step 2 Complete 2.0 and document findings KQL query Azure Sentinel Microsoft Defender
âœ… Enhanced step 2: Investigation Step 2
ğŸ” Searching KQL for: Investigation Step 3 Complete 3.0 and document findings KQL query Azure Sentinel Microsoft Defender
âœ… Enhanced step 3: Investigation Step 3
ğŸ” Searching KQL for: Verify VIP User Status Cross verify if the user is VIP or not - with the list (Shared by Arcutis) KQL query Azure Sentinel Microsoft Defender
âœ… Enhanced step 4: Verify VIP User Status
   ğŸ“Š KQL query added (321 chars)
ğŸ” Searching KQL for: Check Application Sign-In Activity Verify the logs whether there is any Application without sign in attempts KQL query Azure Sentinel Microsoft Defender
âœ… Enhanced step 5: Check Application Sign-In Activity
   ğŸ“Š KQL query added (507 chars)
ğŸ” Searching KQL for: Check Application Sign-In Activity If there is any application sign in without password check whether the application is critical or not KQL query Azure Sentinel Microsoft Defender
âœ… Enhanced step 6: Check Application Sign-In Activity
   ğŸ“Š KQL query added (507 chars)
ğŸ” Searching KQL for: Investigation Step 7 If no critical applications close the incident as false positive KQL query Azure Sentinel Microsoft Defender
âœ… Enhanced step 7: Investigation Step 7
   ğŸ“Š KQL query added (353 chars)
ğŸ” Searching KQL for: Investigation Step 8 If any critical application found consider as True Positive KQL query Azure Sentinel Microsoft Defender    
âœ… Enhanced step 8: Investigation Step 8
   ğŸ“Š KQL query added (321 chars)
ğŸ” Searching KQL for: Validate MFA Status Ensure that the passwordless authentication method used is legitimate (e.g., biometrics, hardware tokens).If there is critical applications without password then reach out IT team to set password by enabling MFA KQL query Azure Sentinel Microsoft Defender   
âœ… Enhanced step 9: Validate MFA Status
   ğŸ“Š KQL query added (507 chars)
ğŸ” Searching KQL for: Investigation Step 10 If the authentication is Legitimate then consider it as False Positive and close the incident KQL query Azure Sentinel Microsoft Defender
âœ… Enhanced step 10: Investigation Step 10
   ğŸ“Š KQL query added (507 chars)
ğŸ” Searching KQL for: Investigation Step 11 If unauthorized, take appropriate action such as locking accounts, resetting passwords, or investigating further. KQL query Azure Sentinel Microsoft Defender
âœ… Enhanced step 11: Investigation Step 11
   ğŸ“Š KQL query added (321 chars)
ğŸ” Searching KQL for: Investigation Step 12 Enhance monitoring to detect similar events in the future KQL query Azure Sentinel Microsoft Defender     
âœ… Enhanced step 12: Investigation Step 12
   ğŸ“Š KQL query added (321 chars)

================================================================================
âœ… ENHANCEMENT COMPLETE
   Original steps: 12
   Enhanced steps: 12
   Steps with KQL: 9
================================================================================

Successfully loaded: data\A - Q3 - Daily Incident Tracker_Dashboard  - Jul to Sep2025(April 25).csv
Successfully loaded: data\A - Q3 - Daily Incident Tracker_Dashboard  - Jul to Sep2025(July 25).csv
Successfully loaded: data\A - Q3 - Daily Incident Tracker_Dashboard  - Jul to Sep2025(June 25).csv
Successfully loaded: data\A - Q3 - Daily Incident Tracker_Dashboard  - Jul to Sep2025(May 25).csv
Successfully loaded: data\Arcutis - Q3 - Daily Incident Tracker_Dashboard  - Jul to Sep2025(Aug 25).csv
Successfully loaded: data\Arcutis - Q3 - Daily Incident Tracker_Dashboard  - Jul to Sep2025(Sep 25).csv
Total records loaded: 5082

================================================================================
GENERATING TEMPLATE FOR Rule#183-Detect passwordless authentication
================================================================================

--- Processing Step 1 ---
âœ… Step Name: Document Investigation Data

ğŸ” Generating KQL for: Document Investigation Data
ğŸŒ Searching: Microsoft Sentinel KQL query Document Investigation Data Rule#183-Detect passwordless authentication
âœ… Generated using LLM
âœ… KQL Generated: 648 chars

--- Processing Step 2 ---
âœ… Step Name: Document Investigation Data

ğŸ” Generating KQL for: Document Investigation Data
ğŸŒ Searching: Microsoft Sentinel KQL query Document Investigation Data Rule#183-Detect passwordless authentication
âœ… Generated using LLM
âœ… KQL Generated: 2282 chars

--- Processing Step 3 ---
âœ… Step Name: Document Investigation Data

ğŸ” Generating KQL for: Document Investigation Data
ğŸŒ Searching: Microsoft Sentinel KQL query Document Investigation Data Rule#183-Detect passwordless authentication
âœ… Generated using LLM
âœ… KQL Generated: 1205 chars

--- Processing Step 4 ---
âœ… Step Name: Verify VIP User Status

ğŸ” Generating KQL for: Verify VIP User Status
âœ… Generated from pattern matching
âœ… KQL Generated: 220 chars

--- Processing Step 5 ---
âœ… Step Name: Check Application Sign-In Activity

ğŸ” Generating KQL for: Check Application Sign-In Activity
âœ… Generated from pattern matching
âœ… KQL Generated: 675 chars

--- Processing Step 6 ---
âœ… Step Name: Check Application Sign-In Activity

ğŸ” Generating KQL for: Check Application Sign-In Activity
âœ… Generated from pattern matching
âœ… KQL Generated: 675 chars

--- Processing Step 7 ---
âœ… Step Name: Review Investigation Data

ğŸ” Generating KQL for: Review Investigation Data
ğŸŒ Searching: Microsoft Sentinel KQL query Review Investigation Data Rule#183-Detect passwordless authentication
âœ… Generated using LLM
âœ… KQL Generated: 1308 chars

--- Processing Step 8 ---
âœ… Step Name: Review Investigation Data

ğŸ” Generating KQL for: Review Investigation Data
ğŸŒ Searching: Microsoft Sentinel KQL query Review Investigation Data Rule#183-Detect passwordless authentication
âœ… Generated using LLM
âœ… KQL Generated: 725 chars

--- Processing Step 9 ---
âœ… Step Name: Validate MFA Status

ğŸ” Generating KQL for: Validate MFA Status
âœ… Generated from pattern matching
âœ… KQL Generated: 675 chars

--- Processing Step 10 ---
âœ… Step Name: Review Authentication Activity

ğŸ” Generating KQL for: Review Authentication Activity
âœ… Generated from pattern matching
âœ… KQL Generated: 675 chars

--- Processing Step 11 ---
âœ… Step Name: Execute User Identity Information

ğŸ” Generating KQL for: Execute User Identity Information
ğŸŒ Searching: Microsoft Sentinel KQL query Execute User Identity Information Rule#183-Detect passwordless authentication
âš ï¸ No KQL query generated
âš ï¸ No KQL query (documentation step)

--- Processing Step 12 ---
âœ… Step Name: Review Investigation Data

ğŸ” Generating KQL for: Review Investigation Data
ğŸŒ Searching: Microsoft Sentinel KQL query Review Investigation Data Rule#183-Detect passwordless authentication









Sr.No. Inputs Required INPUT details Instructions Rule#183 - Detect passwordless authentication Paswordless aunthintication may be happen due to compromised account or privileged account. 1 Incident 208306 2 Reported Time ######## 3 Provide the username which are involved in the incident obarkhordarian@arcutis.com,jfennewald@arcutis.com,nkolla@arcutis.com 4 VIPS Users ? No Cross verify if the user is VIP or not - with the list (Shared by Arcutis)  5 Run the KQL query Triaging steps: IP : Clean, Closure comments :Observed events, checked sign in logs of users(obarkhordarian@arcutis.com,jfennewald@arcutis.com,nkolla@arcutis.com), clean IP, using registered devices and known apps nothing suspicious found , closing as a false positive Verify the logs whether there is any Application without sign in attempts 6 Collect the basic info like UserName, App DisplayName, User Agent, Time Triaging steps: IP : Clean, Closure comments :Observed events, checked sign in logs of users(obarkhordarian@arcutis.com,jfennewald@arcutis.com,nkolla@arcutis.com), clean IP, using registered devices and known apps nothing suspicious found , closing as a false positive If there is any application sign in without password check whether the application is critical or not 7 User Confirmation - If YES  No need If no critical applications close the incident as false positive 8 User Confirmation --- NO. (True Positive)  NA If any critical application found consider as True Positive 9 Run The KQL to check - AD logs (Sign in logs) Yes, run user signin logs Ensure that the passwordless authentication method used is legitimate (e.g., biometrics, hardware tokens).If there is critical applications without password then reach out IT team to set password by enabling MFA  10 User Account Details iwalsh@arcutis.com If the authentication is Legitimate then consider it as False Positive and close the incident 11 Inform to IT Team no need If unauthorized, take appropriate action such as locking accounts, resetting passwords, or investigating further. 12 Track for the closer/closer confirmation Enhance monitoring to detect similar events in the future   


You're almost there with the output just some updations required this is the existing template for the reference 
1. Steps are not relevent and getting repeated 
2. Take steps from the template if you want not directly but just take learning from this 
3. KQL Queries are not clean make it clean it is good that providing in each step keep it like that
4. If you wnat you can add explaination of the kql query beside in another column but don't add in that existing thing

Give me the sections to update and avoid hardcoding