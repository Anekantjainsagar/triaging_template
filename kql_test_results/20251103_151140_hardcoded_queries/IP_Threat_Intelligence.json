{
  "query_name": "IP Threat Intelligence",
  "query_type": "hardcoded",
  "timestamp": "2025-11-03T15:11:57.211586",
  "stages": {
    "template_validation": {
      "passed": true,
      "query_length": 2084
    },
    "data_injection": {
      "passed": true,
      "injected_query_length": 2156,
      "users_injected": 1,
      "ips_injected": 1,
      "reference_datetime": "2025-11-03 10:30:00"
    },
    "execution": {
      "success": false,
      "execution_time": 2.14,
      "formatted_output": "Query failed: 400 - {\"error\":{\"message\":\"The request had some invalid properties\",\"code\":\"BadArgumentError\",\"correlationId\":\"b4a46428-77e8-4ecb-9cba-f3167a3afc04\",\"innererror\":{\"code\":\"SemanticError\",\"message\":\"A semantic error occurred.\",\"innererror\":{\"code\":\"SEM0100\",\"message\":\"'extend' operator: Failed to resolve column or scalar expression named 'SuccessRate'\"}}}}",
      "raw_results": null,
      "result_rows": 0,
      "error": "Query failed: 400 - {\"error\":{\"message\":\"The request had some invalid properties\",\"code\":\"BadArgumentError\",\"correlationId\":\"b4a46428-77e8-4ecb-9cba-f3167a3afc04\",\"innererror\":{\"code\":\"SemanticError\",\"message\":\"A semantic error occurred.\",\"innererror\":{\"code\":\"SEM0100\",\"message\":\"'extend' operator: Failed to resolve column or scalar expression named 'SuccessRate'\"}}}}"
    }
  },
  "injected_query": "SigninLogs\n| where TimeGenerated > datetime(2025-10-27 10:30:00Z) and TimeGenerated <= datetime(2025-11-03 10:30:00Z)\n| where IPAddress in (\"8.8.8.8\")\n| extend\n    Country = tostring(LocationDetails.countryOrRegion),\n    City = tostring(LocationDetails.city),\n    ISP = tostring(AutonomousSystemNumber)\n| summarize\n    TotalAttempts = count(),\n    UniqueUsers = dcount(UserPrincipalName),\n    UniqueApplications = dcount(AppDisplayName),\n    SuccessfulLogins = countif(ResultType == \"0\"),\n    FailedLogins = countif(ResultType != \"0\"),\n    RiskySignIns = countif(IsRisky == true),\n    HighRiskSignIns = countif(RiskLevelAggregated == \"high\"),\n    MediumRiskSignIns = countif(RiskLevelAggregated == \"medium\"),\n    InteractiveLogins = countif(IsInteractive == true),\n    NonInteractiveLogins = countif(IsInteractive == false),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated),\n    UniqueCountries = dcount(Country),\n    UniqueCities = dcount(City),\n    UsersList = make_set(UserPrincipalName, 20),\n    ApplicationsList = make_set(AppDisplayName, 10),\n    CountriesList = make_set(Country, 5),\n    RiskEvents = make_set(RiskEventTypes_V2, 10)\n    by IPAddress, ISP\n| extend\n    DaysSeen = datetime_diff('day', LastSeen, FirstSeen) + 1,\n    SuccessRate = round(100.0 * SuccessfulLogins / TotalAttempts, 2),\n    IPThreatScore = (HighRiskSignIns * 10) + (MediumRiskSignIns * 5) + (FailedLogins * 2) + (UniqueUsers * 3),\n    ThreatClassification = case(\n        HighRiskSignIns > 5, \"ðŸ”´ Critical Threat - Malicious Actor\",\n        HighRiskSignIns > 0, \"ðŸŸ  High Risk - Known Threat\",\n        FailedLogins > 20, \"ðŸŸ¡ Suspicious - Brute Force Pattern\",\n        SuccessRate < 40, \"âš ï¸ Concerning - Low Success Rate\",\n        UniqueUsers > 10, \"ðŸ“Š Shared IP - Multiple Users\",\n        \"ðŸŸ¢ Normal Activity\"\n    ),\n    UsagePattern = case(\n        DaysSeen == 1 and TotalAttempts > 20, \"Burst Activity\",\n        DaysSeen > 7, \"Persistent Access\",\n        TotalAttempts > 50, \"High Volume\",\n        \"Standard Usage\"\n    )\n| project-reorder IPAddress, ThreatClassification, IPThreatScore, TotalAttempts, UniqueUsers, SuccessRate\n| order by IPThreatScore desc",
  "status": "FAILED"
}