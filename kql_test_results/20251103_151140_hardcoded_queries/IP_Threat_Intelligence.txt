====================================================================================================
Query: IP Threat Intelligence
Type: hardcoded
Status: FAILED
Timestamp: 2025-11-03T15:11:57.211586
====================================================================================================

STAGE RESULTS:
----------------------------------------------------------------------------------------------------

TEMPLATE_VALIDATION:
  passed: True
  query_length: 2084

DATA_INJECTION:
  passed: True
  injected_query_length: 2156
  users_injected: 1
  ips_injected: 1
  reference_datetime: 2025-11-03 10:30:00

EXECUTION:
  success: False
  execution_time: 2.14
  formatted_output:
    Query failed: 400 - {"error":{"message":"The request had some invalid properties","code":"BadArgumentError","correlationId":"b4a46428-77e8-4ecb-9cba-f3167a3afc04","innererror":{"code":"SemanticError","message":"A semantic error occurred.","innererror":{"code":"SEM0100","message":"'extend' operator: Failed to resolve column or scalar expression named 'SuccessRate'"}}}}
  raw_results: None
  result_rows: 0
  error:
    Query failed: 400 - {"error":{"message":"The request had some invalid properties","code":"BadArgumentError","correlationId":"b4a46428-77e8-4ecb-9cba-f3167a3afc04","innererror":{"code":"SemanticError","message":"A semantic error occurred.","innererror":{"code":"SEM0100","message":"'extend' operator: Failed to resolve column or scalar expression named 'SuccessRate'"}}}}

====================================================================================================
INJECTED QUERY (READY TO EXECUTE):
====================================================================================================
SigninLogs
| where TimeGenerated > datetime(2025-10-27 10:30:00Z) and TimeGenerated <= datetime(2025-11-03 10:30:00Z)
| where IPAddress in ("8.8.8.8")
| extend
    Country = tostring(LocationDetails.countryOrRegion),
    City = tostring(LocationDetails.city),
    ISP = tostring(AutonomousSystemNumber)
| summarize
    TotalAttempts = count(),
    UniqueUsers = dcount(UserPrincipalName),
    UniqueApplications = dcount(AppDisplayName),
    SuccessfulLogins = countif(ResultType == "0"),
    FailedLogins = countif(ResultType != "0"),
    RiskySignIns = countif(IsRisky == true),
    HighRiskSignIns = countif(RiskLevelAggregated == "high"),
    MediumRiskSignIns = countif(RiskLevelAggregated == "medium"),
    InteractiveLogins = countif(IsInteractive == true),
    NonInteractiveLogins = countif(IsInteractive == false),
    FirstSeen = min(TimeGenerated),
    LastSeen = max(TimeGenerated),
    UniqueCountries = dcount(Country),
    UniqueCities = dcount(City),
    UsersList = make_set(UserPrincipalName, 20),
    ApplicationsList = make_set(AppDisplayName, 10),
    CountriesList = make_set(Country, 5),
    RiskEvents = make_set(RiskEventTypes_V2, 10)
    by IPAddress, ISP
| extend
    DaysSeen = datetime_diff('day', LastSeen, FirstSeen) + 1,
    SuccessRate = round(100.0 * SuccessfulLogins / TotalAttempts, 2),
    IPThreatScore = (HighRiskSignIns * 10) + (MediumRiskSignIns * 5) + (FailedLogins * 2) + (UniqueUsers * 3),
    ThreatClassification = case(
        HighRiskSignIns > 5, "ðŸ”´ Critical Threat - Malicious Actor",
        HighRiskSignIns > 0, "ðŸŸ  High Risk - Known Threat",
        FailedLogins > 20, "ðŸŸ¡ Suspicious - Brute Force Pattern",
        SuccessRate < 40, "âš ï¸ Concerning - Low Success Rate",
        UniqueUsers > 10, "ðŸ“Š Shared IP - Multiple Users",
        "ðŸŸ¢ Normal Activity"
    ),
    UsagePattern = case(
        DaysSeen == 1 and TotalAttempts > 20, "Burst Activity",
        DaysSeen > 7, "Persistent Access",
        TotalAttempts > 50, "High Volume",
        "Standard Usage"
    )
| project-reorder IPAddress, ThreatClassification, IPThreatScore, TotalAttempts, UniqueUsers, SuccessRate
| order by IPThreatScore desc

====================================================================================================
QUERY EXECUTION RESULTS:
====================================================================================================
Execution Time: 2.14 seconds
Result Rows: 0
Success: False

FORMATTED OUTPUT:
----------------------------------------------------------------------------------------------------
Query failed: 400 - {"error":{"message":"The request had some invalid properties","code":"BadArgumentError","correlationId":"b4a46428-77e8-4ecb-9cba-f3167a3afc04","innererror":{"code":"SemanticError","message":"A semantic error occurred.","innererror":{"code":"SEM0100","message":"'extend' operator: Failed to resolve column or scalar expression named 'SuccessRate'"}}}}

====================================================================================================
RAW RESULTS (JSON):
====================================================================================================
null

====================================================================================================
ERROR DETAILS:
====================================================================================================
Query failed: 400 - {"error":{"message":"The request had some invalid properties","code":"BadArgumentError","correlationId":"b4a46428-77e8-4ecb-9cba-f3167a3afc04","innererror":{"code":"SemanticError","message":"A semantic error occurred.","innererror":{"code":"SEM0100","message":"'extend' operator: Failed to resolve column or scalar expression named 'SuccessRate'"}}}}
