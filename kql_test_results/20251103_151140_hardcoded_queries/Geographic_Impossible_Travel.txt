====================================================================================================
Query: Geographic/Impossible Travel
Type: hardcoded
Status: PASSED
Timestamp: 2025-11-03T15:11:55.035015
====================================================================================================

STAGE RESULTS:
----------------------------------------------------------------------------------------------------

TEMPLATE_VALIDATION:
  passed: True
  query_length: 2024

DATA_INJECTION:
  passed: True
  injected_query_length: 2109
  users_injected: 1
  ips_injected: 1
  reference_datetime: 2025-11-03 10:30:00

EXECUTION:
  success: True
  execution_time: 1.67
  formatted_output:
    Results: 3 row(s) returned

================================================================================
UserPrincipalName     | TravelRisk         | Country         | City            | LocationRiskScore | SignInCount     | State           | UniqueIPsInLocation | SuccessfulSignIns | FailedSignIns   | RiskySignIns    | FirstSeenInLocation          | LastSeenInLocation           | IPAddressesList    | MinTimeBetweenLocations
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
anekant.jain@yash.com | ğŸ  Domestic - India | IN              | Mumbai          | 20                | 2               | Maharashtra     | 1                   | 1                 | 1               | 0               | 2025-10-31T07:18:57.1714641Z | 2025-10-31T07:19:59.7909736Z | ["14.194.129.210"] | 1                      
anekant.jain@yash.com | ğŸ  Domestic - India | IN              | New Delhi       | 20                | 1               | Delhi           | 1                   | 1                 | 0               | 0               | 2025-10-31T07:18:58.4717436Z | 2025-10-31T07:18:58.4717436Z | ["125.23.93.22"]   | 0                      
anekant.jain@yash.com | ğŸ  Domestic - India | IN              | Indore          | 0                 | 1               | Madhya Pradesh  | 1                   | 0                 | 1               | 0               | 2025-10-30T10:56:11.9982207Z | 2025-10-30T10:56:11.9982207Z | ["106.219.84.254"] | None                   
================================================================================

Total Records: 3
  raw_results: {'tables': [{'name': 'PrimaryResult', 'columns': [{'name': 'UserPrincipalName', 'type': 'string'}, {'name': 'TravelRisk', 'type': 'string'}, {'name': 'Country', 'type': 'string'}, {'name': 'City', 'type': 'string'}, {'name': 'LocationRiskScore', 'type': 'long'}, {'name': 'SignInCount', 'type': 'long'}, {'name': 'State', 'type': 'string'}, {'name': 'UniqueIPsInLocation', 'type': 'long'}, {'name': 'SuccessfulSignIns', 'type': 'long'}, {'name': 'FailedSignIns', 'type': 'long'}, {'name': 'RiskySignIns', 'type': 'long'}, {'name': 'FirstSeenInLocation', 'type': 'datetime'}, {'name': 'LastSeenInLocation', 'type': 'datetime'}, {'name': 'IPAddressesList', 'type': 'dynamic'}, {'name': 'MinTimeBetweenLocations', 'type': 'long'}], 'rows': [['anekant.jain@yash.com', 'ğŸ  Domestic - India', 'IN', 'Mumbai', 20, 2, 'Maharashtra', 1, 1, 1, 0, '2025-10-31T07:18:57.1714641Z', '2025-10-31T07:19:59.7909736Z', '["14.194.129.210"]', 1], ['anekant.jain@yash.com', 'ğŸ  Domestic - India', 'IN', 'New Delhi', 20, 1, 'Delhi', 1, 1, 0, 0, '2025-10-31T07:18:58.4717436Z', '2025-10-31T07:18:58.4717436Z', '["125.23.93.22"]', 0], ['anekant.jain@yash.com', 'ğŸ  Domestic - India', 'IN', 'Indore', 0, 1, 'Madhya Pradesh', 1, 0, 1, 0, '2025-10-30T10:56:11.9982207Z', '2025-10-30T10:56:11.9982207Z', '["106.219.84.254"]', None]]}]}
  result_rows: 1

====================================================================================================
INJECTED QUERY (READY TO EXECUTE):
====================================================================================================
SigninLogs
| where TimeGenerated > datetime(2025-10-04 10:30:00Z) and TimeGenerated <= datetime(2025-11-03 10:30:00Z)
| where UserPrincipalName in ("anekant.jain@yash.com")
| extend
    Country = tostring(LocationDetails.countryOrRegion),
    City = tostring(LocationDetails.city),
    State = tostring(LocationDetails.state),
    Latitude = toreal(LocationDetails.geoCoordinates.latitude),
    Longitude = toreal(LocationDetails.geoCoordinates.longitude)
| order by TimeGenerated asc
| extend
    PreviousCountry = prev(Country, 1),
    PreviousCity = prev(City, 1),
    PreviousTime = prev(TimeGenerated, 1),
    PreviousLatitude = prev(Latitude, 1),
    PreviousLongitude = prev(Longitude, 1)
| extend
    TimeDiffMinutes = datetime_diff('minute', TimeGenerated, PreviousTime),
    LocationChanged = iff(Country != PreviousCountry or City != PreviousCity, "Yes", "No")
| where LocationChanged == "Yes"
| summarize
    SignInCount = count(),
    UniqueIPsInLocation = dcount(IPAddress),
    SuccessfulSignIns = countif(ResultType == "0"),
    FailedSignIns = countif(ResultType != "0"),
    RiskySignIns = countif(IsRisky == true),
    FirstSeenInLocation = min(TimeGenerated),
    LastSeenInLocation = max(TimeGenerated),
    IPAddressesList = make_set(IPAddress, 5),
    MinTimeBetweenLocations = min(TimeDiffMinutes)
    by UserPrincipalName, Country, City, State
| extend
    TravelRisk = case(
        MinTimeBetweenLocations < 60 and Country != "IN", "ğŸš¨ IMPOSSIBLE TRAVEL - <1 Hour",
        MinTimeBetweenLocations < 180 and Country != "IN", "âš ï¸ Suspicious Travel - <3 Hours",
        MinTimeBetweenLocations < 360 and Country != "IN", "âš¡ Fast Travel - <6 Hours",
        Country != "IN", "âœˆï¸ International Access",
        "ğŸ  Domestic - India"
    ),
    LocationRiskScore = case(
        MinTimeBetweenLocations < 60, 20,
        MinTimeBetweenLocations < 180, 15,
        MinTimeBetweenLocations < 360, 10,
        Country != "IN", 5,
        0
    )
| project-reorder UserPrincipalName, TravelRisk, Country, City, LocationRiskScore, SignInCount
| order by LocationRiskScore desc, SignInCount desc

====================================================================================================
QUERY EXECUTION RESULTS:
====================================================================================================
Execution Time: 1.67 seconds
Result Rows: 1
Success: True

FORMATTED OUTPUT:
----------------------------------------------------------------------------------------------------
Results: 3 row(s) returned

================================================================================
UserPrincipalName     | TravelRisk         | Country         | City            | LocationRiskScore | SignInCount     | State           | UniqueIPsInLocation | SuccessfulSignIns | FailedSignIns   | RiskySignIns    | FirstSeenInLocation          | LastSeenInLocation           | IPAddressesList    | MinTimeBetweenLocations
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
anekant.jain@yash.com | ğŸ  Domestic - India | IN              | Mumbai          | 20                | 2               | Maharashtra     | 1                   | 1                 | 1               | 0               | 2025-10-31T07:18:57.1714641Z | 2025-10-31T07:19:59.7909736Z | ["14.194.129.210"] | 1                      
anekant.jain@yash.com | ğŸ  Domestic - India | IN              | New Delhi       | 20                | 1               | Delhi           | 1                   | 1                 | 0               | 0               | 2025-10-31T07:18:58.4717436Z | 2025-10-31T07:18:58.4717436Z | ["125.23.93.22"]   | 0                      
anekant.jain@yash.com | ğŸ  Domestic - India | IN              | Indore          | 0                 | 1               | Madhya Pradesh  | 1                   | 0                 | 1               | 0               | 2025-10-30T10:56:11.9982207Z | 2025-10-30T10:56:11.9982207Z | ["106.219.84.254"] | None                   
================================================================================

Total Records: 3

====================================================================================================
RAW RESULTS (JSON):
====================================================================================================
{
  "tables": [
    {
      "name": "PrimaryResult",
      "columns": [
        {
          "name": "UserPrincipalName",
          "type": "string"
        },
        {
          "name": "TravelRisk",
          "type": "string"
        },
        {
          "name": "Country",
          "type": "string"
        },
        {
          "name": "City",
          "type": "string"
        },
        {
          "name": "LocationRiskScore",
          "type": "long"
        },
        {
          "name": "SignInCount",
          "type": "long"
        },
        {
          "name": "State",
          "type": "string"
        },
        {
          "name": "UniqueIPsInLocation",
          "type": "long"
        },
        {
          "name": "SuccessfulSignIns",
          "type": "long"
        },
        {
          "name": "FailedSignIns",
          "type": "long"
        },
        {
          "name": "RiskySignIns",
          "type": "long"
        },
        {
          "name": "FirstSeenInLocation",
          "type": "datetime"
        },
        {
          "name": "LastSeenInLocation",
          "type": "datetime"
        },
        {
          "name": "IPAddressesList",
          "type": "dynamic"
        },
        {
          "name": "MinTimeBetweenLocations",
          "type": "long"
        }
      ],
      "rows": [
        [
          "anekant.jain@yash.com",
          "ğŸ  Domestic - India",
          "IN",
          "Mumbai",
          20,
          2,
          "Maharashtra",
          1,
          1,
          1,
          0,
          "2025-10-31T07:18:57.1714641Z",
          "2025-10-31T07:19:59.7909736Z",
          "[\"14.194.129.210\"]",
          1
        ],
        [
          "anekant.jain@yash.com",
          "ğŸ  Domestic - India",
          "IN",
          "New Delhi",
          20,
          1,
          "Delhi",
          1,
          1,
          0,
          0,
          "2025-10-31T07:18:58.4717436Z",
          "2025-10-31T07:18:58.4717436Z",
          "[\"125.23.93.22\"]",
          0
        ],
        [
          "anekant.jain@yash.com",
          "ğŸ  Domestic - India",
          "IN",
          "Indore",
          0,
          1,
          "Madhya Pradesh",
          1,
          0,
          1,
          0,
          "2025-10-30T10:56:11.9982207Z",
          "2025-10-30T10:56:11.9982207Z",
          "[\"106.219.84.254\"]",
          null
        ]
      ]
    }
  ]
}
